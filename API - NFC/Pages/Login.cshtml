@page
@model LoginModel
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Acceso - NFC</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet" />
</head>
<body style="background:var(--brand-bg); display:flex; align-items:center; min-height:100vh;">
    <style>
        :root {
            --brand-green: #08701C;
            --brand-green-dark: #055314;
            --brand-green-light: #13A236;
            --brand-blue: #006BB3;
            --brand-blue-dark: #004F82;
            --brand-teal: #0087A8;
            --brand-yellow: #D9A400;
            --brand-danger: #C53030;
            --brand-bg: #F3F5F7;
            --brand-white: #FFFFFF;
            --border-soft: #E2E6EA;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 18px;
            --shadow-soft: 0 4px 16px -4px rgba(0,0,0,.12);
            --shadow-card: 0 8px 28px -10px rgba(0,0,0,.25);
            --transition: .2s ease;
            --gradient-green-teal: linear-gradient(90deg,#08701C 0%, #0087A8 100%);
            --gradient-green-blue: linear-gradient(90deg,#08701C 0%, #006BB3 100%);
            --gradient-green: #08701C;
        }

        html, body {
            background: var(--brand-bg);
            font-family: system-ui, 'Inter', Arial, sans-serif;
            color: #1F2A33;
            min-height: 100vh;
        }

        .login-wrapper {
            max-width: 430px;
            width: 100%;
            margin: auto;
        }

        .gradient-header-login {
            background: var(--gradient-green-teal);
            color: #fff;
            padding: 1.1rem 1.2rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            font-weight: 600;
            letter-spacing: .5px;
            display: flex;
            align-items: center;
            gap: .55rem;
        }

        .tab-switch {
            display: flex;
            width: 100%;
        }

            .tab-switch button {
                flex: 1;
                border: none;
                padding: .75rem;
                font-weight: 600;
                font-size: .8rem;
                background: #E7EDF0;
                letter-spacing: .6px;
                cursor: pointer;
                transition: var(--transition);
                color: #184A26;
            }

                .tab-switch button.active {
                    background: var(--brand-green);
                    color: #fff;
                }

                .tab-switch button:hover:not(.active) {
                    background: #DCE3E6;
                }

        .login-card {
            background: #fff;
            border: 1px solid var(--border-soft);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            overflow: hidden;
        }

        .btn-brand {
            background: var(--brand-green);
            color: #fff;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            padding: .65rem 1.05rem;
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            transition: var(--transition);
        }

            .btn-brand:hover {
                background: var(--brand-green-dark);
            }

        .form-control, .form-select {
            border-radius: var(--radius-md);
            border: 1px solid var(--border-soft);
            background: #F9FBFC;
            font-size: .9rem;
            transition: var(--transition);
        }

            .form-control:focus, .form-select:focus {
                border-color: var(--brand-green-light);
                box-shadow: 0 0 0 .15rem rgba(8,112,28,.25);
                background: #fff;
            }

        .alert-inline {
            display: none;
            margin-bottom: .65rem;
            font-size: .7rem;
            border-radius: var(--radius-md);
            padding: .55rem .7rem;
        }

            .alert-inline.ok {
                background: #D7F5DC;
                border: 1px solid #A9E8B2;
                color: #1F4F29;
            }

            .alert-inline.err {
                background: #F9D5D4;
                border: 1px solid #F2A29F;
                color: #7A2422;
            }

        .small-link {
            font-size: .7rem;
            text-decoration: none;
            color: var(--brand-blue);
            font-weight: 500;
        }

            .small-link:hover {
                text-decoration: underline;
            }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .spinner-dot {
            width: 18px;
            height: 18px;
            border: 3px solid rgba(0,0,0,.15);
            border-top-color: var(--brand-green);
            border-radius: 50%;
            animation: spin .85s linear infinite;
            display: none;
        }

        .footer-bar {
            font-size: .7rem;
            color: #5B6773;
            padding: 1.5rem 0;
            text-align: center;
        }

    
    </style>

    <div class="login-wrapper">
        <div class="login-card">
            <div class="gradient-header-login">
                <span style="font-size:1rem;">Bienvenido</span>
            </div>

            <div class="tab-switch">
                <button id="btnTabLogin" class="active">LOGIN</button>
                <button id="btnTabRegister">REGISTRO</button>
            </div>

            <!-- ALERTAS -->
            <div id="alertLoginErr" class="alert-inline err"></div>
            <div id="alertLoginOk" class="alert-inline ok"></div>
            <div id="alertRegErr" class="alert-inline err"></div>
            <div id="alertRegOk" class="alert-inline ok"></div>

            <!-- LOGIN -->
            <div id="paneLogin" style="padding:1.2rem;">
                <form id="formLogin" autocomplete="off">
                    <div class="mb-3">
                        <label class="form-label">Correo</label>
                        <input type="email" class="form-control" id="loginCorreo" required placeholder="usuario@correo.com">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="loginPass" required minlength="4" placeholder="••••••">
                    </div>
                    <div class="flex-between mb-3">
                        <a href="#" id="linkRecuperar" class="small-link">Recuperar contraseña</a>
                        <div class="d-flex gap-3">
                            <a href="#" id="linkVerToken" class="small-link">Ver token</a>
                            <a href="#" id="linkClear" class="small-link">Limpiar sesión</a>
                        </div>
                    </div>
                    <button type="submit" class="btn-brand w-100" id="btnLogin">
                        <span id="spinnerLogin" class="spinner-dot me-2"></span> Entrar
                    </button>
                    <p class="text-center mt-3 small-link" style="cursor:default; text-decoration:none;">
                        Roles habilitados: Administrador / Guardia
                    </p>
                </form>
            </div>

            <!-- REGISTRO -->
            <div id="paneRegister" style="display:none; padding:1.2rem;">
                <form id="formRegister" autocomplete="off">
                    <div class="row">
                        <div class="col-6 mb-2">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" name="Nombre" id="regNombre" required minlength="2">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label">Apellido</label>
                            <input type="text" class="form-control" name="Apellido" id="regApellido" required minlength="2">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-2">
                            <label class="form-label">Tipo Doc.</label>
                            <select class="form-select" name="TipoDocumento" id="regTipoDoc" required>
                                <option value="">--</option>
                                <option value="CC">CC</option>
                                <option value="TI">TI</option>
                                <option value="CE">CE</option>
                                <option value="PA">PA</option>
                            </select>
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label">N° Documento</label>
                            <input type="text" class="form-control" name="NumeroDocumento" id="regNumDoc" required minlength="4">
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Correo</label>
                        <input type="email" class="form-control" name="Correo" id="regCorreo" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Contraseña</label>
                        <input type="password" class="form-control" name="Contraseña" id="regPass" required minlength="6">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-2">
                            <label class="form-label">Rol</label>
                            <select class="form-select" name="Rol" id="regRol" required>
                                <option value="">--</option>
                                <option value="Administrador">Administrador</option>
                                <option value="Guardia">Guardia</option>
                                <option value="Funcionario">Funcionario</option>
                            </select>
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label">Código Barras (op)</label>
                            <input type="text" class="form-control" name="CodigoBarras" id="regCB">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-2">
                            <label class="form-label">Cargo (op)</label>
                            <input type="text" class="form-control" name="Cargo" id="regCargo">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label">Teléfono (op)</label>
                            <input type="text" class="form-control" name="Telefono" id="regTel">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Foto URL (op)</label>
                        <input type="url" class="form-control" name="FotoUrl" id="regFoto" placeholder="https://...">
                    </div>
                    <button type="submit" class="btn-brand w-100" id="btnReg">
                        <span id="spinnerReg" class="spinner-dot me-2"></span> Registrar
                    </button>
                    <p class="text-center mt-3 small-link" style="cursor:default;">Si no das Código Barras se genera automático.</p>
                </form>
            </div>
        </div>

        <div class="footer-bar mt-4">
            &copy; @DateTime.UtcNow.Year NFC SENA · Seguridad &amp; Control
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function(){
          // Tabs
          const btnTabLogin     = document.getElementById('btnTabLogin');
          const btnTabRegister  = document.getElementById('btnTabRegister');
          const paneLogin       = document.getElementById('paneLogin');
          const paneRegister    = document.getElementById('paneRegister');

          function activate(tab){
            if(tab === 'login'){
              btnTabLogin.classList.add('active');
              btnTabRegister.classList.remove('active');
              paneLogin.style.display='block';
              paneRegister.style.display='none';
            } else {
              btnTabRegister.classList.add('active');
              btnTabLogin.classList.remove('active');
              paneRegister.style.display='block';
              paneLogin.style.display='none';
            }
          }
          btnTabLogin.addEventListener('click', ()=>activate('login'));
          btnTabRegister.addEventListener('click', ()=>activate('register'));

          // Utilidades
          const show = (el,msg)=>{ el.textContent=msg; el.style.display='block'; };
          const hide = el=>{ el.textContent=''; el.style.display='none'; };
          function decodeJwt(t){
            if(!t) return null;
            try{
              const p = t.split('.')[1];
              const j = atob(p.replace(/-/g,'+').replace(/_/g,'/'));
              return JSON.parse(j);
            }catch { return null; }
          }
          async function safeParse(resp){
            const ct = resp.headers.get('content-type')||'';
            if(ct.includes('application/json')){
              try{ return await resp.json(); }catch { return {}; }
            }
            return { rawText: await resp.text() };
          }

          // LOGIN
          const formLogin   = document.getElementById('formLogin');
          const loginError  = document.getElementById('alertLoginErr');
          const loginOk     = document.getElementById('alertLoginOk');
          const spinnerLogin= document.getElementById('spinnerLogin');
          const btnLogin    = document.getElementById('btnLogin');
          const linkRecuperar = document.getElementById('linkRecuperar');
          const linkVerToken  = document.getElementById('linkVerToken');
          const linkClear     = document.getElementById('linkClear');

          formLogin.addEventListener('submit', async e=>{
            e.preventDefault();
            hide(loginError); hide(loginOk);
            const correo = document.getElementById('loginCorreo').value.trim();
            const pass   = document.getElementById('loginPass').value;
            if(!correo || !pass){
              show(loginError,'Complete los campos.');
              return;
            }
            btnLogin.disabled=true;
            spinnerLogin.style.display='inline-block';
            try{
              const resp = await fetch('/api/auth/login',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ Correo: correo, Contraseña: pass })
              });
              const data = await safeParse(resp);
              if(!resp.ok){
                const msg = data.error || data.message || data.rawText || ('Error '+resp.status);
                show(loginError,msg);
              } else {
                const token = data.token || data.Token;
                const usr   = data.usuario || data.Usuario;
                if(!token){
                  show(loginError,'Respuesta inesperada (sin token).');
                } else {
                  // Guardar token y usuario
                  localStorage.setItem('auth_token', token);
                  if(usr) localStorage.setItem('user_info', JSON.stringify(usr));

                  // 👮‍♂️ Si es guardia, guardar también su IdUsuario como guard_id
                  if (usr && (usr.Rol || usr.rol)) {
                      const rolLocal = (usr.Rol || usr.rol).toString().trim().toLowerCase();
                      if (rolLocal === 'guardia') {
                          const guardId = usr.IdUsuario || usr.idUsuario;
                          if (guardId) {
                              localStorage.setItem('guard_id', guardId.toString());
                          }
                      }
                  }

                  show(loginOk, 'Bienvenido ' + (usr?.Nombre || usr?.nombre || '') + ' (' + (usr?.Rol || usr?.rol || '') + ')');

                  // 🔐 Decidir a dónde ir según el rol
                  const decoded = decodeJwt(token);
                  const rolToken =
                      decoded?.role ||
                      decoded?.Rol ||
                      decoded?.["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"];

                  const rolLocal2 = usr?.Rol || usr?.rol;
                  const rolFinal = (rolLocal2 || rolToken || '').toString().trim().toLowerCase();

                  let redirectUrl = '/Login'; // valor por defecto

                  if (rolFinal === 'guardia') {
                      // ✅ Candado: marcamos que VIENE del login hacia la Terminal
                      sessionStorage.setItem('terminal_auth_ok', '1');
                      redirectUrl = '/Terminal';
                  } else if (rolFinal === 'administrador') {
                      redirectUrl = '/Admin/Usuarios';
                  }

                  setTimeout(() => { window.location.href = redirectUrl; }, 800);
                }
              }
            }catch{
              show(loginError,'Fallo de red.');
            }finally{
              btnLogin.disabled=false;
              spinnerLogin.style.display='none';
            }
          });

          linkRecuperar.addEventListener('click', async e=>{
            e.preventDefault();
            const correo = prompt('Correo para recuperación:');
            if(!correo) return;

            try{
              const resp = await fetch('/api/auth/RECUPERAR-password',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ Correo: correo.trim() })
              });

              const data = await safeParse(resp);

              if (!resp.ok) {
                alert(data.error || data.rawText || 'Error al solicitar recuperación.');
              } else {
                alert('Si existe una cuenta con ese correo, recibirás un email con instrucciones para restablecer tu contraseña. Revisa bandeja de entrada y spam.');
              }
            } catch (err) {
              alert('Fallo de red.');
            }
          });

          linkVerToken.addEventListener('click', e=>{
            e.preventDefault();
            const t = localStorage.getItem('auth_token');
            if(!t){ alert('No hay token.'); return; }
            const d = decodeJwt(t);
            const rol = d?.role || d?.Rol || d?.["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"];
            alert('Token inicio:\n'+t.substring(0,55)+'...\nRol: '+(rol||'N/D'));
          });

          // 🔴 BOTÓN LIMPIAR SESIÓN
          linkClear.addEventListener('click', e=>{
            e.preventDefault();
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_info');
            localStorage.removeItem('guard_id');
            sessionStorage.removeItem('terminal_auth_ok');
            alert('Sesión limpiada.');
          });

          // REGISTRO
          const formRegister = document.getElementById('formRegister');
          const regError     = document.getElementById('alertRegErr');
          const regOk        = document.getElementById('alertRegOk');
          const spinnerReg   = document.getElementById('spinnerReg');
          const btnReg       = document.getElementById('btnReg');

          formRegister.addEventListener('submit', async e=>{
            e.preventDefault();
            hide(regError); hide(regOk);
            const fd = new FormData(formRegister);
            const payload = {
              Nombre: fd.get('Nombre')?.toString().trim(),
              Apellido: fd.get('Apellido')?.toString().trim(),
              TipoDocumento: fd.get('TipoDocumento')?.toString().trim(),
              NumeroDocumento: fd.get('NumeroDocumento')?.toString().trim(),
              Correo: fd.get('Correo')?.toString().trim(),
              Contraseña: fd.get('Contraseña')?.toString(),
              Rol: fd.get('Rol')?.toString().trim(),
              CodigoBarras: fd.get('CodigoBarras')?.toString().trim(),
              Cargo: fd.get('Cargo')?.toString().trim(),
              Telefono: fd.get('Telefono')?.toString().trim(),
              FotoUrl: fd.get('FotoUrl')?.toString().trim()
            };

            if(!payload.Nombre || !payload.Apellido || !payload.TipoDocumento ||
               !payload.NumeroDocumento || !payload.Correo || !payload.Contraseña || !payload.Rol){
              show(regError,'Completa todos los requeridos.');
              return;
            }
            if(payload.Contraseña.length < 6){
              show(regError,'Contraseña mínima 6 caracteres.');
              return;
            }
            btnReg.disabled=true;
            spinnerReg.style.display='inline-block';
            try{
              const resp = await fetch('/api/auth/register',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(payload)
              });
              const data = await safeParse(resp);
              if(!resp.ok){
                const msg = data.error || data.message || data.rawText || 'Error';
                show(regError, msg);
              } else {
                show(regOk,'Registro exitoso. Ve a Login.');
                setTimeout(()=>{
                  btnTabLogin.click();
                  hide(regOk);
                }, 1500);
              }
            }catch{
              show(regError,'Fallo de red.');
            }finally{
              btnReg.disabled=false;
              spinnerReg.style.display='none';
            }
          });
        })();
    </script>
</body>
</html>
