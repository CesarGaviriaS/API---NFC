@page
@model LoginModel
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Acceso - NFC</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet" />
</head>
<body>
    <style>
        :root {
            --brand-green: #08701C;
            --brand-green-dark: #055314;
            --brand-green-light: #13A236;
            --brand-blue: #006BB3;
            --brand-blue-dark: #004F82;
            --brand-teal: #0087A8;
            --brand-yellow: #D9A400;
            --brand-danger: #C53030;
            --brand-bg: #F3F5F7;
            --brand-white: #FFFFFF;
            --border-soft: #E2E6EA;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 18px;
            --shadow-soft: 0 4px 16px -4px rgba(0,0,0,.12);
            --shadow-card: 0 8px 28px -10px rgba(0,0,0,.25);
            --transition: .2s ease;
            --gradient-green-teal: linear-gradient(135deg,#08701C 0%, #0087A8 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            background: var(--brand-bg);
            font-family: system-ui, 'Inter', Arial, sans-serif;
            color: #1F2A33;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container-fluid {
            min-height: 100vh;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .split-screen {
            display: flex;
            max-width: 950px;
            width: 85%;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            background: white;
            flex-wrap: wrap;
        }

        .left-panel {
            flex: 1;
            background: var(--gradient-green-teal);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            position: relative;
            min-height: 300px;
            overflow: hidden;
        }

            .left-panel::before {
                content: '';
                position: absolute;
                width: 500px;
                height: 500px;
                background: rgba(255,255,255,0.1);
                border-radius: 50%;
                top: -150px;
                left: -150px;
            }

            .left-panel::after {
                content: '';
                position: absolute;
                width: 350px;
                height: 350px;
                background: rgba(255,255,255,0.08);
                border-radius: 50%;
                bottom: -100px;
                right: -100px;
            }

        .welcome-content {
            text-align: center;
            color: white;
            z-index: 1;
            max-width: 400px;
        }

            .welcome-content h1 {
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 1rem;
                text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            }

            .welcome-content p {
                font-size: 1.1rem;
                opacity: 0.95;
                margin-bottom: 2rem;
            }

        .toggle-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 0.75rem 2.5rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

            .toggle-btn:hover {
                background: white;
                color: var(--brand-green);
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            }

        .right-panel {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 2rem 2.5rem;
            overflow-y: auto;
            height: auto;
            max-height: none;
            background: white;
        }

        .form-container {
            width: 100%;
            max-width: 420px;
        }

        .form-header {
            margin-bottom: 1.5rem;
        }

            .form-header h2 {
                font-size: 1.75rem;
                font-weight: 700;
                color: var(--brand-green);
                margin-bottom: 0.3rem;
            }

            .form-header p {
                color: #5B6773;
                font-size: 0.85rem;
            }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #1F2A33;
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
        }

        .input-wrapper {
            position: relative;
        }

        .form-control, .form-select {
            width: 100%;
            padding: 0.7rem 0.9rem;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-soft);
            background: #F9FBFC;
            font-size: 0.875rem;
            transition: var(--transition);
        }

            .form-control:focus, .form-select:focus {
                outline: none;
                border-color: var(--brand-green-light);
                background: white;
                box-shadow: 0 0 0 3px rgba(8,112,28,0.1);
            }

        .btn-primary {
            width: 100%;
            background: var(--gradient-green-teal);
            border: none;
            color: white;
            padding: 0.9rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(8,112,28,0.3);
            }

            .btn-primary:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

        .alert-inline {
            display: none;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
        }

            .alert-inline.ok {
                background: #D7F5DC;
                border: 1px solid #A9E8B2;
                color: #1F4F29;
            }

            .alert-inline.err {
                background: #F9D5D4;
                border: 1px solid #F2A29F;
                color: #7A2422;
            }

        .small-links {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .small-link {
            font-size: 0.85rem;
            text-decoration: none;
            color: var(--brand-blue);
            font-weight: 500;
            transition: var(--transition);
        }

            .small-link:hover {
                color: var(--brand-blue-dark);
                text-decoration: underline;
            }

        .spinner-dot {
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }

  

        .info-text {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.8rem;
            color: #5B6773;
        }

        .sena-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding: 0.6rem;
            background: rgba(255,255,255,0.15);
            border-radius: var(--radius-md);
            backdrop-filter: blur(10px);
        }

            .sena-badge span {
                font-size: 0.8rem;
                font-weight: 600;
                color: white;
                text-align: center;
                line-height: 1.3;
            }

        .footer-bar {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #5B6773;
            text-align: center;
        }

       

        .left-panel {
            min-height: 220px;
            padding: 2rem;
        }

        .right-panel {
            padding: 2rem 1rem;
        }

        .small-links {
            flex-direction: column;
            align-items: flex-start;
        }

        }
    </style>

    <div class="container-fluid">
        <div class="split-screen">
            <!-- Panel Izquierdo -->
            <div class="left-panel" id="leftPanel">
                <div class="welcome-content">
                    <h1 id="welcomeTitle">¡Hola, Bienvenido!</h1>
                    <p id="welcomeText">¿No tienes una cuenta?</p>
                    <button class="toggle-btn" id="toggleBtn">Registrar</button>

                    <div class="sena-badge">
                        <span>CIMM - Centro Industrial de<br>Mantenimiento y Manufactura<br>SENA</span>
                    </div>
                </div>
            </div>

            <!-- Panel Derecho -->
            <div class="right-panel">
                <div class="form-container">
                    <!-- ALERTAS -->
                    <div id="alertLoginErr" class="alert-inline err"></div>
                    <div id="alertLoginOk" class="alert-inline ok"></div>
                    <div id="alertRegErr" class="alert-inline err"></div>
                    <div id="alertRegOk" class="alert-inline ok"></div>

                    <!-- FORMULARIO LOGIN -->
                    <div id="loginForm">
                        <div class="form-header">
                            <h2>Iniciar Sesión</h2>
                            <p>Ingresa tus credenciales para continuar</p>
                        </div>

                        <form id="formLogin" autocomplete="off">
                            <div class="form-group">
                                <label class="form-label">Correo Electrónico</label>
                                <div class="input-wrapper">
                                    <input type="email" class="form-control" id="loginCorreo" required placeholder="usuario@correo.com">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Contraseña</label>
                                <div class="input-wrapper">
                                    <input type="password" class="form-control" id="loginPass" required minlength="4" placeholder="••••••••">
                                </div>
                            </div>

                            <div class="small-links">
                                <a href="#" id="linkRecuperar" class="small-link">¿Olvidaste tu contraseña?</a>
                                <div style="display: flex; gap: 1rem;">
                                </div>
                            </div>

                            <button type="submit" class="btn-primary" id="btnLogin">
                                <span id="spinnerLogin" class="spinner-dot"></span>
                                Entrar
                            </button>

                            <p class="info-text">
                                <strong>Roles habilitados:</strong> Administrador / Guardia
                            </p>
                        </form>
                    </div>

                    <!-- FORMULARIO REGISTRO -->
                    <div id="registerForm" style="display: none;">
                        <div class="form-header">
                            <h2>Crear Cuenta</h2>
                            <p>Completa los datos para registrarte</p>
                        </div>

                        <form id="formRegister" autocomplete="off">
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label class="form-label">Nombre</label>
                                        <input type="text" class="form-control" name="Nombre" id="regNombre" required minlength="2" placeholder="Juan">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label class="form-label">Apellido</label>
                                        <input type="text" class="form-control" name="Apellido" id="regApellido" required minlength="2" placeholder="Pérez">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label class="form-label">Tipo Doc.</label>
                                        <select class="form-select" name="TipoDocumento" id="regTipoDoc" required>
                                            <option value="">Seleccionar</option>
                                            <option value="CC">CC</option>
                                            <option value="TI">TI</option>
                                            <option value="CE">CE</option>
                                            <option value="PA">PA</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label class="form-label">N° Documento</label>
                                        <input type="text" class="form-control" name="NumeroDocumento" id="regNumDoc" required minlength="4" placeholder="12345678">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Correo Electrónico</label>
                                <input type="email" class="form-control" name="Correo" id="regCorreo" required placeholder="usuario@correo.com">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Contraseña</label>
                                <input type="password" class="form-control" name="Contraseña" id="regPass" required minlength="6" placeholder="Mínimo 6 caracteres">
                            </div>

                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label class="form-label">Rol</label>
                                        <select class="form-select" name="Rol" id="regRol" required>
                                            <option value="">Seleccionar</option>
                                            <option value="Guardia">Guardia</option>
                                        </select>

                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label class="form-label">Código Barras (opcional)</label>
                                        <input type="text" class="form-control" name="CodigoBarras" id="regCB" placeholder="Código">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label class="form-label">Cargo (opcional)</label>
                                        <input type="text" class="form-control" name="Cargo" id="regCargo" placeholder="Tu cargo">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label class="form-label">Teléfono (opcional)</label>
                                        <input type="text" class="form-control" name="Telefono" id="regTel" placeholder="3001234567">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Foto URL (opcional)</label>
                                <input type="url" class="form-control" name="FotoUrl" id="regFoto" placeholder="https://...">
                            </div>

                            <button type="submit" class="btn-primary" id="btnReg">
                                <span id="spinnerReg" class="spinner-dot"></span>
                                Registrar
                            </button>

                            <p class="info-text">Si no proporcionas un código de barras, se generará automáticamente.</p>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-bar">
            &copy; @DateTime.UtcNow.Year NFC SENA · Seguridad &amp; Control
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function(){
          // Toggle entre Login y Registro
          const toggleBtn = document.getElementById('toggleBtn');
          const welcomeTitle = document.getElementById('welcomeTitle');
          const welcomeText = document.getElementById('welcomeText');
          const loginForm = document.getElementById('loginForm');
          const registerForm = document.getElementById('registerForm');

          let isLogin = true;

          toggleBtn.addEventListener('click', () => {
            isLogin = !isLogin;

            if (isLogin) {
              welcomeTitle.textContent = '¡Hola, Bienvenido!';
              welcomeText.textContent = '¿No tienes una cuenta?';
              toggleBtn.textContent = 'Registrar';
              loginForm.style.display = 'block';
              registerForm.style.display = 'none';
            } else {
              welcomeTitle.textContent = '¡Bienvenido de nuevo!';
              welcomeText.textContent = '¿Ya tienes una cuenta?';
              toggleBtn.textContent = 'Iniciar Sesión';
              loginForm.style.display = 'none';
              registerForm.style.display = 'block';
            }
          });

          // Utilidades
          const show = (el, msg) => {
            el.textContent = msg;
            el.style.display = 'block';
          };

          const hide = el => {
            el.textContent = '';
            el.style.display = 'none';
          };

          function decodeJwt(t) {
            if(!t) return null;
            try {
              const p = t.split('.')[1];
              const j = atob(p.replace(/-/g,'+').replace(/_/g,'/'));
              return JSON.parse(j);
            } catch {
              return null;
            }
          }

          async function safeParse(resp) {
            const ct = resp.headers.get('content-type') || '';
            if(ct.includes('application/json')) {
              try {
                return await resp.json();
              } catch {
                return {};
              }
            }
            return { rawText: await resp.text() };
          }

          // ---------------- LOGIN ----------------
          const formLogin = document.getElementById('formLogin');
          const loginError = document.getElementById('alertLoginErr');
          const loginOk = document.getElementById('alertLoginOk');
          const spinnerLogin = document.getElementById('spinnerLogin');
          const btnLogin = document.getElementById('btnLogin');
          const linkRecuperar = document.getElementById('linkRecuperar');

          formLogin.addEventListener('submit', async e => {
            e.preventDefault();
            hide(loginError);
            hide(loginOk);

            const correo = document.getElementById('loginCorreo').value.trim();
            const pass = document.getElementById('loginPass').value;

            if(!correo || !pass) {
              show(loginError, 'Complete todos los campos.');
              return;
            }

            btnLogin.disabled = true;
            spinnerLogin.style.display = 'inline-block';

            try {
              const resp = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ Correo: correo, Contraseña: pass })
              });

              const data = await safeParse(resp);

              if(!resp.ok) {
                const msg = data.error || data.message || data.rawText || ('Error ' + resp.status);
                show(loginError, msg);
              } else {
                const token = data.token || data.Token;
                const usr = data.usuario || data.Usuario;

                if(!token) {
                  show(loginError, 'Respuesta inesperada (sin token).');
                } else {
                
                  localStorage.setItem('auth_token', token);
                  document.cookie = `AuthToken=${token}; path=/; secure; samesite=strict`;
                  if(usr) localStorage.setItem('user_info', JSON.stringify(usr));

                 
                  if (usr && (usr.Rol || usr.rol)) {
                    const rolLocal = (usr.Rol || usr.rol).toString().trim().toLowerCase();
                    if (rolLocal === 'guardia') {
                      const guardId = usr.IdUsuario || usr.idUsuario;
                      if (guardId) {
                        localStorage.setItem('guard_id', guardId.toString());
                      }
                    }
                  }

                  show(loginOk, 'Bienvenido ' + (usr?.Nombre || '') + ' (' + (usr?.Rol || '') + ')');

                  const decoded = decodeJwt(token);
                  const rolToken = decoded?.role || decoded?.Rol || decoded?.["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"];
                  const rolFinal = (usr?.Rol || rolToken || '').toString().trim().toLowerCase();

                  let redirectUrl = '/Login';
                  if (rolFinal === 'guardia') {
                    sessionStorage.setItem('terminal_auth_ok', '1');
                    redirectUrl = '/Terminal';
                  } else if (rolFinal === 'administrador') {
                    redirectUrl = '/Admin/Usuarios';
                  }

                  setTimeout(() => {
                    window.location.href = redirectUrl;
                  }, 1200);
                }
              }
            } catch {
              show(loginError, 'Error de conexión. Intenta nuevamente.');
            } finally {
              btnLogin.disabled = false;
              spinnerLogin.style.display = 'none';
            }
          });

                 // Recuperar contraseña - VERSIÓN SIMPLE
        linkRecuperar.addEventListener('click', async e => {
            e.preventDefault();

            // Ocultar login y mostrar formulario de recuperación
            loginForm.style.display = 'none';

            // Crear formulario de recuperación
            const formContainer = document.querySelector('.form-container');
            const recuperarDiv = document.createElement('div');
            recuperarDiv.id = 'recuperarForm';
            recuperarDiv.innerHTML = `
                <div class="form-header">
                    <h2>Recuperar Contraseña</h2>
                    <p>Ingresa tu documento y correo para verificar tu identidad</p>
                </div>

                <div id="alertRecuperarErr" class="alert-inline err" style="display: none;"></div>
                <div id="alertRecuperarOk" class="alert-inline ok" style="display: none;"></div>

                <form id="formRecuperar" autocomplete="off">
                    <div class="form-group">
                        <label class="form-label">Número de Documento</label>
                        <input type="text" class="form-control" id="recuperarDocumento"
                               required placeholder="123456789">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" id="recuperarCorreo"
                               required placeholder="usuario@correo.com">
                    </div>

                    <button type="submit" class="btn-primary" id="btnRecuperar">
                        <span id="spinnerRecuperar" class="spinner-dot"></span>
                        Verificar Datos
                    </button>

                    <div class="small-links" style="margin-top: 1rem;">
                        <a href="#" id="btnVolverLogin" class="small-link">
                            ← Volver al inicio de sesión
                        </a>
                    </div>
                </form>

                <!-- Formulario para cambiar contraseña (oculto inicialmente) -->
                <form id="formCambiarPass" style="display: none;" autocomplete="off">
                    <div class="form-header">
                        <h2>Nueva Contraseña</h2>
                        <p id="nombreUsuarioRecuperar"></p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Nueva Contraseña</label>
                        <input type="password" class="form-control" id="nuevaPassword"
                               required minlength="6" placeholder="Mínimo 6 caracteres">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Confirmar Nueva Contraseña</label>
                        <input type="password" class="form-control" id="confirmarPassword"
                               required minlength="6" placeholder="Repite la contraseña">
                    </div>

                    <button type="submit" class="btn-primary" id="btnCambiar">
                        <span id="spinnerCambiar" class="spinner-dot"></span>
                        Cambiar Contraseña
                    </button>
                </form>
            `;

            formContainer.appendChild(recuperarDiv);

            // ===== EVENTOS =====

            let idUsuarioRecuperar = 0;

            // Volver al login
            document.getElementById('btnVolverLogin').addEventListener('click', (e) => {
                e.preventDefault();
                recuperarDiv.remove();
                loginForm.style.display = 'block';
                hide(loginError);
                hide(loginOk);
            });

            // Verificar documento y correo
            document.getElementById('formRecuperar').addEventListener('submit', async (e) => {
                e.preventDefault();

                const alertErr = document.getElementById('alertRecuperarErr');
                const alertOk = document.getElementById('alertRecuperarOk');
                const spinner = document.getElementById('spinnerRecuperar');
                const btn = document.getElementById('btnRecuperar');

                hide(alertErr);
                hide(alertOk);

                const documento = document.getElementById('recuperarDocumento').value.trim();
                const correo = document.getElementById('recuperarCorreo').value.trim();

                if (!documento || !correo) {
                    show(alertErr, 'Completa todos los campos.');
                    return;
                }

                btn.disabled = true;
                spinner.style.display = 'inline-block';

                try {
                    const resp = await fetch('/api/auth/recuperar-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            NumeroDocumento: documento,
                            Correo: correo
                        })
                    });

                    const data = await safeParse(resp);

                    if (!resp.ok) {
                        show(alertErr, data.error || 'No se encontró un usuario con esos datos.');
                    } else {
                        // Usuario verificado, mostrar formulario de cambio de contraseña
                        idUsuarioRecuperar = data.idUsuario;
                        document.getElementById('nombreUsuarioRecuperar').textContent =
                            `Usuario: ${data.nombre} ${data.apellido}`;

                        document.getElementById('formRecuperar').style.display = 'none';
                        document.getElementById('formCambiarPass').style.display = 'block';
                    }
                } catch {
                    show(alertErr, 'Error de conexión. Intenta nuevamente.');
                } finally {
                    btn.disabled = false;
                    spinner.style.display = 'none';
                }
            });

            // Cambiar contraseña
            document.getElementById('formCambiarPass').addEventListener('submit', async (e) => {
                e.preventDefault();

                const alertErr = document.getElementById('alertRecuperarErr');
                const alertOk = document.getElementById('alertRecuperarOk');
                const spinner = document.getElementById('spinnerCambiar');
                const btn = document.getElementById('btnCambiar');

                hide(alertErr);
                hide(alertOk);

                const nuevaPass = document.getElementById('nuevaPassword').value;
                const confirmarPass = document.getElementById('confirmarPassword').value;

                if (nuevaPass.length < 6) {
                    show(alertErr, 'La contraseña debe tener al menos 6 caracteres.');
                    return;
                }

                if (nuevaPass !== confirmarPass) {
                    show(alertErr, 'Las contraseñas no coinciden.');
                    return;
                }

                btn.disabled = true;
                spinner.style.display = 'inline-block';

                try {
                    const resp = await fetch('/api/auth/cambiar-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            IdUsuario: idUsuarioRecuperar,
                            NuevaContraseña: nuevaPass
                        })
                    });

                    const data = await safeParse(resp);

                    if (!resp.ok) {
                        show(alertErr, data.error || 'Error al cambiar la contraseña.');
                    } else {
                        show(alertOk, data.message || '✅ Contraseña actualizada correctamente.');

                        // Volver al login después de 2 segundos
                        setTimeout(() => {
                            recuperarDiv.remove();
                            loginForm.style.display = 'block';
                            hide(loginError);
                            show(loginOk, 'Contraseña cambiada. Ya puedes iniciar sesión.');

                            // Limpiar después de 5 segundos
                            setTimeout(() => hide(loginOk), 5000);
                        }, 2000);
                    }
                } catch {
                    show(alertErr, 'Error de conexión. Intenta nuevamente.');
                } finally {
                    btn.disabled = false;
                    spinner.style.display = 'none';
                }
            });
        });

          // ---------------- REGISTRO ----------------
          const formRegister = document.getElementById('formRegister');
          const regError = document.getElementById('alertRegErr');
          const regOk = document.getElementById('alertRegOk');
          const spinnerReg = document.getElementById('spinnerReg');
          const btnReg = document.getElementById('btnReg');

          formRegister.addEventListener('submit', async e => {
            e.preventDefault();
            hide(regError);
            hide(regOk);

            const fd = new FormData(formRegister);

           
            const payload = {
              Nombre: fd.get('Nombre')?.toString().trim(),
              Apellido: fd.get('Apellido')?.toString().trim(),
              TipoDocumento: fd.get('TipoDocumento')?.toString().trim(),
              NumeroDocumento: fd.get('NumeroDocumento')?.toString().trim(),
              Correo: fd.get('Correo')?.toString().trim(),
              Contraseña: fd.get('Contraseña')?.toString(),
              Rol: fd.get('Rol')?.toString().trim(),

              CodigoBarras: fd.get('CodigoBarras')?.toString().trim() || null,
              Cargo: fd.get('Cargo')?.toString().trim() || null,
              Telefono: fd.get('Telefono')?.toString().trim() || null,
              FotoUrl: fd.get('FotoUrl')?.toString().trim() || null
            };

            // Validación
            if(!payload.Nombre || !payload.Apellido || !payload.TipoDocumento ||
               !payload.NumeroDocumento || !payload.Correo || !payload.Contraseña || !payload.Rol) {
              show(regError, 'Completa todos los campos requeridos.');
              return;
            }

            if(payload.Contraseña.length < 6) {
              show(regError, 'La contraseña debe tener mínimo 6 caracteres.');
              return;
            }

            btnReg.disabled = true;
            spinnerReg.style.display = 'inline-block';

            try {
              const resp = await fetch('/api/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
              });

              const data = await safeParse(resp);

              if(!resp.ok) {
                const msg = data.error || data.message || data.rawText || 'Error en el registro';
                show(regError, msg);
              } else {
                show(regOk, 'Registro exitoso. Redirigiendo...');
                setTimeout(() => {
                  toggleBtn.click();
                  hide(regOk);
                  formRegister.reset();
                }, 1800);
              }
            } catch {
              show(regError, 'Error de conexión. Intenta nuevamente.');
            } finally {
              btnReg.disabled = false;
              spinnerReg.style.display = 'none';
            }
          });

        })();
    </script>

</body>
</html>