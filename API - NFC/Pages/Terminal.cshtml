@page
@model API___NFC.Pages.TerminalModel
@{
    ViewData["Title"] = "NFC HUB (Terminal)";
    Layout = "_AdminLayout";
}

<style>
    :root {
        --sena-verde: #39A900;
        --sena-azul: #0B7CBD;
        --sena-naranja: #FF6600;
        --borde-suave: #dee2e6;
        --fondo: #f8f9fa;
        --texto: #212529;
        --sombra: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
        --radio: 0.75rem;
    }

    body {
        background-color: var(--fondo);
        font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        color: var(--texto);
    }

    .card {
        border-radius: var(--radio);
        box-shadow: var(--sombra);
        transition: all 0.2s ease-in-out;
    }

        .card:hover {
            transform: translateY(-2px);
        }

    .card-header {
        font-weight: 600;
        border: none;
        color: #fff;
        padding: 1rem;
        font-size: 1rem;
    }

        .card-header.blue {
            background: linear-gradient(135deg, var(--sena-azul), #1d7ed6);
        }

        .card-header.green {
            background: linear-gradient(135deg, var(--sena-verde), #4bbb3f);
        }

    .profile-card {
        display: flex;
        gap: 1rem;
        align-items: center;
        padding: 1rem;
    }

    .profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 1rem;
        background: linear-gradient(135deg, var(--sena-verde), var(--sena-azul));
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2rem;
        color: #fff;
        box-shadow: var(--sombra);
        border: 3px solid #fff;
    }

    .profile-details {
        background: #fff;
        border-left: 4px solid var(--sena-verde);
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        line-height: 1.6;
    }

    .device-item {
        display: flex;
        background: #fff;
        padding: 1rem;
        border-radius: var(--radio);
        border: 1px solid var(--borde-suave);
        margin-bottom: 0.75rem;
        gap: 1rem;
        align-items: center;
        transition: 0.2s ease;
    }

        .device-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra);
        }

    .device-icon {
        width: 48px;
        height: 48px;
        border-radius: 0.5rem;
        background: #e7f1fa;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        color: var(--sena-azul);
    }

    .device-name {
        font-weight: 600;
        color: var(--sena-azul);
    }

    .device-details {
        font-size: 0.85rem;
        color: #6c757d;
    }

    #history-list {
        max-height: 80vh;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .history-item {
        padding: 0.75rem 1rem;
        background: #fff;
        border-radius: 0.5rem;
        border-left: 4px solid var(--sena-azul);
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }

        .history-item.ingreso {
            border-left-color: var(--sena-verde);
        }

        .history-item.salida {
            border-left-color: var(--sena-naranja);
        }

    .toast {
        border-radius: 0.75rem;
        box-shadow: var(--sombra);
    }

    button.btn {
        border-radius: 0.5rem;
        font-weight: 500;
        transition: transform 0.15s ease-in-out;
    }

        button.btn:hover {
            transform: scale(1.03);
        }

    input.form-control,
    select.form-select {
        border-radius: 0.5rem;
        box-shadow: none;
        transition: border-color 0.2s ease;
    }

        input.form-control:focus,
        select.form-select:focus {
            border-color: var(--sena-azul);
            outline: none;
        }

    .modal-content {
        border-radius: 0.75rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        overflow: hidden;
    }

    .modal-header {
        background: var(--sena-azul);
        color: #fff;
        border-bottom: none;
        padding: 1rem 1.25rem;
    }

        .modal-header h5 {
            margin: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

    .modal-body {
        background: #f8f9fa;
        padding: 1.5rem;
    }

        .modal-body h6 {
            font-weight: 600;
            font-size: 1rem;
            color: var(--sena-azul);
            margin-bottom: 0.5rem;
        }

    .modal-footer {
        background-color: #f1f1f1;
        border-top: none;
        padding: 1rem 1.25rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    #modalUserData {
        background-color: #e7f3ff;
        border-left: 4px solid var(--sena-azul);
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
    }

    #modal-user-devices {
        background: #fff;
        border: 1px solid var(--borde-suave);
        border-radius: 0.5rem;
        padding: 0.75rem;
    }

    html.guard-check-pending {
        visibility: hidden;
    }

    /* ✅ ESTILOS MEJORADOS PARA LAS ALERTAS */
    .alert-pendientes {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 2px solid #ffc107;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        animation: fadeInAlert 0.5s ease-in-out;
    }

        .alert-pendientes .alert-heading {
            color: #856404;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

            .alert-pendientes .alert-heading i {
                font-size: 1.8rem;
                animation: pulse 2s infinite;
            }

        .alert-pendientes .alert-content {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

    .alert-pendientes-list {
        list-style: none;
        padding: 0;
        margin: 1rem 0;
    }

        .alert-pendientes-list li {
            background: white;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid #ffc107;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

            .alert-pendientes-list li:before {
                content: "📦";
                font-size: 1.2rem;
            }

    .alert-modo-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.95rem;
    }

        .alert-modo-badge.ingreso {
            background: linear-gradient(135deg, #d1ecf1, #b8daff);
            color: #004085;
            border: 2px solid #0056b3;
        }

        .alert-modo-badge.salida {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #28a745;
        }



    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

  

    50% {
        transform: scale(1.1);
    }

    }

    .toast-custom {
        min-width: 300px;
        font-size: 1rem;
    }
</style>

<div class="container-fluid py-4">

    <!-- PERFIL (PARTE SUPERIOR) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="text-success"><i class="bi bi-person-badge"></i> Perfil</h5>
                    <div class="d-flex gap-2">
                        <button id="btnNuevoProceso" class="btn btn-success">
                            <i class="bi bi-broadcast-pin"></i> Iniciar lectura
                        </button>
                     
                    </div>
                </div>
                <div id="user-profile-content" class="mt-2 text-muted">
                    Esperando lectura...
                </div>
            </div>
        </div>
    </div>

    <!-- FILA INFERIOR: HISTORIAL + DISPOSITIVOS -->
    <div class="row g-3">

        <!-- HISTORIAL -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header blue text-center">
                    <i class="bi bi-clock-history"></i> Historial
                </div>
                <div id="history-list" class="card-body">
                    <p class="text-center text-muted small">Sin registros</p>
                </div>
            </div>
        </div>

        <!-- DISPOSITIVOS DEL USUARIO -->
        <div class="col-md-4">
            <div class="card h-100 p-3">
                <h5 class="text-primary"><i class="bi bi-hdd"></i> Dispositivos del Usuario</h5>
                <div id="user-owner-devices">
                    <p class="text-center text-muted">Sin dispositivos.</p>
                </div>
            </div>
        </div>

        <!-- DISPOSITIVOS EN PROCESO -->
        <div class="col-md-4">
            <div class="card h-100 p-3">
                <h5 class="text-primary"><i class="bi bi-cpu"></i> Dispositivos en Proceso</h5>
                <div id="user-process-devices">
                    <p class="text-center text-muted">No hay dispositivos en proceso.</p>
                </div>

                <div class="text-center mt-2">
                    <button id="btnAddDevice" class="btn btn-outline-success"
                            data-bs-toggle="modal"
                            data-bs-target="#modalAddDevice" disabled>
                        <i class="bi bi-plus-circle"></i> Agregar dispositivo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÚLTIMO DETECTADO (DEBAJO DE TODO) -->
    <div class="row g-3 mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header blue text-center">Último Detectado</div>
                <div id="last-detected-item-content" class="card-body text-center">
                    <div id="pendientes-alert" class="mt-3"></div>

                </div>
            </div>
        </div>
    </div>

    <!-- TOASTS -->
    <div id="toast-container" style="position:fixed;bottom:1rem;right:1rem;z-index:2000;"></div>
</div>

<!-- MODAL REGISTRAR DISPOSITIVO -->
<div class="modal fade" id="modalAddDevice" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title d-flex align-items-center gap-2">
                    <i class="bi bi-pc"></i> Registrar dispositivo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body bg-light">
                <div class="alert alert-info border-start border-4 border-primary rounded-3">
                    <h6 class="mb-1"><i class="bi bi-person-lines-fill"></i> Usuario</h6>
                    <div id="modalUserData" class="small text-muted">Cargando...</div>
                </div>

                <h6 class="text-primary mb-2"><i class="bi bi-hdd-network"></i> Dispositivos existentes</h6>
                <div id="modal-user-devices" class="bg-white border rounded p-3 mb-3" style="max-height:200px; overflow-y:auto;">
                    <p class="text-center text-muted small">Sin dispositivos.</p>
                </div>

                <hr>

                <h6 class="text-success"><i class="bi bi-plus-circle"></i> Crear nuevo dispositivo</h6>
                <form id="formDevice" class="row g-3 mt-2">

                    <div class="col-md-6">
                        <label for="selTipoElemento" class="form-label">Tipo *</label>
                        <select id="selTipoElemento" class="form-select" required>
                            <option value="">Cargando...</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="inpSerial" class="form-label">Serial *</label>
                        <input id="inpSerial" type="text" class="form-control" required>
                    </div>

                    <div class="col-md-6">
                        <label for="inpMarca" class="form-label">Marca</label>
                        <input id="inpMarca" type="text" class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label for="inpModelo" class="form-label">Modelo</label>
                        <input id="inpModelo" type="text" class="form-control">
                    </div>

                    <div class="col-12">
                        <label for="inpDescripcion" class="form-label">Descripción</label>
                        <input id="inpDescripcion" type="text" class="form-control">
                    </div>

                </form>

            </div>

            <div class="modal-footer bg-white">
                <button id="btnGuardarDevice" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> Guardar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

<script>
    // 🎯 CONFIGURACIÓN Y VARIABLES GLOBALES
    const HUB_URL = `${window.location.origin}/nfcHub`;

    const API = {
        aprendiz: id => `/api/Aprendiz/${id}`,
        usuario: id => `/api/Usuario/${id}`,
        tipos: () => `/api/TipoElementoes`,
        owner: (tipo, id) => `/api/Elementoes/byOwner/${tipo}/${id}`,
        crearElem: () => `/api/Elementoes`,
        byProceso: (p) => `/api/ElementoProcesoes/byProceso/${p}`,
        autoRegister: () => `/api/ElementoProcesoes/autoRegister`,
        vincular: () => `/api/ElementoProcesoes`,
        desvincular: id => `/api/ElementoProcesoes/${id}`,
        procesoActivo: (tipo, id) => `/api/Procesoes/activo/${tipo}/${id}`,
        marcarQuedoSena: (id) => `/api/ElementoProcesoes/marcarQuedoSena/${id}`,
        pendientes: (tipo, id) => `/api/ElementoProcesoes/pendientes/${tipo}/${id}`,
        agregarPendientes: () => `/api/ElementoProcesoes/agregarPendientesASalida`
    };

    let procesoActualId = null;
    let tipoPersonaActual = null;
    let idPropietarioActual = null;
    let modoActual = null;
    let nombreUsuarioActual = null;

    const ownerContainer = document.getElementById("user-owner-devices");
    const processContainer = document.getElementById("user-process-devices");
    const profileDiv = document.getElementById("user-profile-content");
    const lastDetected = document.getElementById("last-detected-item-content");
    const historyList = document.getElementById("history-list");
    const btnAddDevice = document.getElementById("btnAddDevice");

    // ✅ FUNCIÓN FETCH CON MANEJO DE ERRORES
    async function safeFetch(url, options = {}) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                let errorMsg = `Error ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.Message || errorData.message || errorMsg;
                } catch { }
                throw new Error(errorMsg);
            }
            return response;
        } catch (error) {
            console.error(`Fetch error for ${url}:`, error);
            throw error;
        }
    }

    function showToast(msg, type = "info") {
        const div = document.createElement("div");
        div.className = `toast toast-custom text-bg-${type} show`;
        div.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${msg}</div>
                <button class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        document.getElementById("toast-container").appendChild(div);
        setTimeout(() => div.remove(), 5000);
    }

    function limpiarProceso() {
        procesoActualId = null;
        tipoPersonaActual = null;
        idPropietarioActual = null;
        modoActual = null;
        nombreUsuarioActual = null;

        ownerContainer.innerHTML = `<p class="text-center text-muted">Sin dispositivos.</p>`;
        processContainer.innerHTML = `<p class="text-center text-muted">No hay dispositivos en proceso.</p>`;
        profileDiv.innerHTML = `<div class="text-muted">Esperando lectura...</div>`;
        lastDetected.innerHTML = `<p class="text-muted">Esperando escaneo...</p>`;
        btnAddDevice.disabled = true;

        // Limpiar alerta de pendientes
        const alertDiv = document.getElementById('pendientes-alert');
        if (alertDiv) alertDiv.innerHTML = '';
    }

    function validarProceso(proceso) {
        if (!proceso) return false;
        const tipo = proceso.tipoPersona || proceso.TipoPersona;
        if (tipo === "Aprendiz") return !!(proceso.idAprendiz || proceso.IdAprendiz);
        if (tipo === "Usuario") return !!(proceso.idUsuario || proceso.IdUsuario);
        return false;
    }

    function mapPersona(tipo, data) {
        const nombre = data.nombre || data.Nombre || "";
        const apellido = data.apellido || data.Apellido || "";
        const tipoDoc = data.tipoDocumento || data.TipoDocumento || "";
        const numDoc = data.numeroDocumento || data.NumeroDocumento || "";
        const correo = data.correo || data.Correo || "";
        const codigo = data.codigoBarras || data.CodigoBarras || "N/A";

        let extra = "";
        if (tipo === "Aprendiz") {
            const fichaData = data.ficha || data.Ficha;
            const codigoFicha = fichaData?.codigo || fichaData?.Codigo || "N/A";
            const programaData = fichaData?.programa || fichaData?.Programa;
            const nombrePrograma = programaData?.nombrePrograma || programaData?.NombrePrograma || "N/A";
            extra = `🎓 Aprendiz<br>📚 Ficha: ${codigoFicha}<br>🎯 ${nombrePrograma}`;
        } else {
            const rol = data.rol || data.Rol || "Funcionario";
            const cargo = data.cargo || data.Cargo;
            extra = `👔 ${rol}${cargo ? `<br>💼 ${cargo}` : ''}`;
        }

        return {
            nombreCompleto: `${nombre} ${apellido}`,
            documento: `${tipoDoc} ${numDoc}`,
            correo: correo,
            codigo: codigo,
            extra: extra
        };
    }

    // ✅ VERIFICAR DISPOSITIVOS PENDIENTES
    async function verificarPendientes() {
        try {
            const res = await safeFetch(API.pendientes(tipoPersonaActual, idPropietarioActual));
            const pendientes = await res.json();
            return pendientes;
        } catch (error) {
            console.error("Error verificando pendientes:", error);
            return [];
        }
    }

    // ✅ MOSTRAR ALERTA DE PENDIENTES MEJORADA
    function mostrarAlertaPendientes(pendientes) {
        const alertDiv = document.getElementById('pendientes-alert');
        if (!alertDiv) return;

        const esIngreso = modoActual === 'Ingreso';
        const cantidad = pendientes.length;

        const listadoDispositivos = pendientes.map(p => {
            const elem = p.elemento || p.Elemento || {};
            const tipo = elem.tipoElemento?.tipo || elem.TipoElemento?.Tipo || 'Dispositivo';
            const marca = elem.marca || elem.Marca || '';
            const modelo = elem.modelo || elem.Modelo || '';
            const serial = elem.serial || elem.Serial || 'N/A';

            return `
                <li>
                    <strong>${tipo}</strong>
                    ${marca || modelo ? `<br><span style="color: #666;">${marca} ${modelo}</span>` : ''}
                    <br><small style="color: #888;">Serial: ${serial}</small>
                </li>
            `;
        }).join('');

        alertDiv.innerHTML = `
            <div class="alert-pendientes">
                <div class="alert-heading">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    ¡Atención! Dispositivos pendientes detectados
                </div>

                <div class="alert-content">
                    <p style="font-size: 1.05rem; color: #856404; margin-bottom: 0.75rem;">
                        <strong>${nombreUsuarioActual}</strong> tiene <strong>${cantidad} dispositivo${cantidad > 1 ? 's' : ''}</strong>
                        que ${cantidad > 1 ? 'quedaron' : 'quedó'} dentro del SENA en un ingreso anterior:
                    </p>

                    <ul class="alert-pendientes-list">
                        ${listadoDispositivos}
                    </ul>

                    <hr style="margin: 1.25rem 0; border-color: #ffc107;">

                    <div style="background: white; padding: 1rem; border-radius: 0.75rem; border: 2px dashed #ffc107;">
                        ${esIngreso
                            ? `
                                <div class="alert-modo-badge ingreso">
                                    <i class="bi bi-info-circle-fill"></i> MODO: INGRESO
                                </div>
                                <p style="margin-top: 1rem; color: #004085; font-size: 0.95rem; line-height: 1.6;">
                                    <strong>📌 ¿Qué significa esto?</strong><br>
                                    Los dispositivos listados arriba <strong>NO se registrarán automáticamente</strong> en este ingreso
                                    porque ya están dentro del SENA. Aparecerán marcados en <span class="badge bg-danger">ROJO</span>
                                    en la lista de "Dispositivos en Proceso".
                                </p>
                                <p style="color: #004085; font-size: 0.9rem; margin-bottom: 0;">
                                    💡 <em>Solo podrás agregar dispositivos nuevos o que no quedaron pendientes.</em>
                                </p>
                            `
                            : `
                                <div class="alert-modo-badge salida">
                                    <i class="bi bi-check-circle-fill"></i> MODO: SALIDA
                                </div>
                                <p style="margin-top: 1rem; color: #155724; font-size: 0.95rem; line-height: 1.6;">
                                    <strong>✅ ¿Qué pasará ahora?</strong><br>
                                    Estos dispositivos <strong>se agregarán automáticamente</strong> a esta salida
                                    porque estaban pendientes desde el último ingreso.
                                </p>
                                <p style="color: #155724; font-size: 0.9rem; margin-bottom: 0;">
                                    💡 <em>Verás estos dispositivos en la sección "Dispositivos en Proceso" cuando el registro termine.</em>
                                </p>
                            `
                        }
                    </div>
                </div>

                <button type="button" class="btn-close position-absolute top-0 end-0 m-3"
                        data-bs-dismiss="alert" aria-label="Cerrar"
                        style="filter: brightness(0.8);"></button>
            </div>
        `;
    }

    // ✅ AUTO-REGISTRAR (SIN PENDIENTES)
    async function autoRegistrarDispositivos() {
        if (modoActual !== "Ingreso") return;

        try {
            const res = await safeFetch(API.autoRegister(), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    idProceso: procesoActualId,
                    tipoPropietario: tipoPersonaActual,
                    idPropietario: idPropietarioActual
                })
            });

            const result = await res.json();
            console.log("Auto-registro:", result);

            if (result.omitidosPendientes > 0) {
                showToast(`⚠️ ${result.omitidosPendientes} dispositivo(s) pendiente(s) no se registraron en este ingreso`, "warning");
            }

            if (result.registrados > 0) {
                showToast(`✅ ${result.registrados} dispositivo(s) registrado(s) correctamente`, "success");
            }

        } catch (error) {
            console.error("Error en auto-registro:", error);
        }
    }

    // ✅ AGREGAR PENDIENTES EN SALIDA
    async function agregarPendientesEnSalida() {
        if (modoActual !== "Salida") return;

        try {
            const res = await safeFetch(API.agregarPendientes(), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    idPropietario: idPropietarioActual,
                    tipoPropietario: tipoPersonaActual,
                    idProcesoSalida: procesoActualId
                })
            });

            const result = await res.json();
            console.log("Pendientes agregados:", result);

            if (result.agregados > 0) {
                showToast(`✅ ${result.agregados} dispositivo(s) pendiente(s) agregado(s) automáticamente a la salida`, "success");
            }

        } catch (error) {
            console.error("Error agregando pendientes:", error);
        }
    }

    // ✅ CARGAR DISPOSITIVOS DEL PROCESO
    async function cargarDispositivosProceso() {
        try {
            processContainer.innerHTML = '';

            // Obtener pendientes
            const pendientes = await verificarPendientes();
            const idsPendientes = pendientes.map(p => (p.elemento || p.Elemento)?.idElemento || (p.elemento || p.Elemento)?.IdElemento);

            // Obtener dispositivos del proceso
            const res = await safeFetch(API.byProceso(procesoActualId));
            const lista = await res.json();

            // 1️⃣ MOSTRAR PENDIENTES PRIMERO
            if (pendientes.length > 0 && modoActual === "Ingreso") {
                pendientes.forEach(p => {
                    const d = p.elemento || p.Elemento || {};
                    const tipo = d.tipoElemento?.tipo || d.TipoElemento?.Tipo || "Dispositivo";

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'device-item';
                    itemDiv.style.borderLeft = '5px solid red';
                    itemDiv.style.background = '#ffe5e5';

                    itemDiv.innerHTML = `
                        <div class="device-icon" style="background: #ffcccc;">
                            <i class="bi bi-${getIconoDispositivo(tipo)} text-danger"></i>
                        </div>
                        <div style="flex:1">
                            <strong class="text-danger">${tipo}</strong><br>
                            ${d.marca || ''} ${d.modelo || ''}<br>
                            <small style="color: #666;">Serial: ${d.serial || 'N/A'}</small><br>
                            <span class="badge bg-danger mt-1">
                                <i class="bi bi-exclamation-triangle"></i> Quedó dentro del SENA
                            </span>
                        </div>
                    `;

                    processContainer.appendChild(itemDiv);
                });
            }

            // 2️⃣ MOSTRAR DISPOSITIVOS NORMALES (EXCLUIR PENDIENTES)
            lista.forEach(ep => {
                const d = ep.elemento || ep.Elemento || {};
                const idElem = d.idElemento || d.IdElemento;

                // ❌ NO mostrar si es pendiente
                if (idsPendientes.includes(idElem)) return;

                const relId = ep.idElementoProceso || ep.IdElementoProceso;
                const tipo = d.tipoElemento?.tipo || d.TipoElemento?.Tipo || "Dispositivo";

                const itemDiv = document.createElement('div');
                itemDiv.className = 'device-item';

                let botonHTML = '';
                if (modoActual === "Salida") {
                    botonHTML = `
                        <button class="btn btn-danger btn-sm" onclick="marcarComoQuedoEnSena(${relId})">
                            <i class="bi bi-x-circle"></i> No lo saqué
                        </button>
                    `;
                } else if (modoActual === "Ingreso") {
                    botonHTML = `
                        <button class="btn btn-outline-danger btn-sm" onclick="removeFromProcess(${relId})">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                }

                itemDiv.innerHTML = `
                    <div class="device-icon">
                        ${d.imagenUrl
                            ? `<img src="${d.imagenUrl}" style="width:48px;height:48px;border-radius:6px;object-fit:cover;">`
                            : `<i class="bi bi-${getIconoDispositivo(tipo)}"></i>`
                        }
                    </div>
                    <div style="flex:1">
                        <strong>${tipo}</strong><br>
                        ${d.marca || ''} ${d.modelo || ''}<br>
                        <small style="color: #666;">Serial: ${d.serial || 'N/A'}</small>
                    </div>
                    ${botonHTML}
                `;

                processContainer.appendChild(itemDiv);
            });

            if (processContainer.children.length === 0) {
                processContainer.innerHTML = `<p class="text-center text-muted">No hay dispositivos en proceso.</p>`;
            }

        } catch (error) {
            console.error("Error cargando dispositivos:", error);
            processContainer.innerHTML = `<p class="text-danger text-center">Error de conexión</p>`;
        }
    }

    // ✅ MARCAR COMO "QUEDÓ EN SENA"
    async function marcarComoQuedoEnSena(relId) {
        if (!confirm("¿Confirmas que este dispositivo QUEDARÁ dentro del SENA?\n\nSe marcará como pendiente y aparecerá en el próximo ingreso.")) {
            return;
        }

        try {
            await safeFetch(API.marcarQuedoSena(relId), {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            });

            showToast("📌 Dispositivo marcado como 'quedó en el SENA'", "warning");
            await cargarDispositivosProceso();

        } catch (error) {
            showToast(`❌ Error: ${error.message}`, "danger");
        }
    }

    // ✅ CARGAR DISPOSITIVOS DEL USUARIO
    async function cargarDispositivosUsuario() {
        try {
            const res = await safeFetch(API.owner(tipoPersonaActual, idPropietarioActual));
            const dispositivos = await res.json();

            if (dispositivos.length === 0) {
                ownerContainer.innerHTML = `<p class="text-muted text-center">Sin dispositivos registrados.</p>`;
                return;
            }

            ownerContainer.innerHTML = dispositivos.map(d => {
                const tipo = d.tipoElemento?.tipo || d.TipoElemento?.Tipo || "Dispositivo";
                const imagen = d.imagenUrl || d.ImagenUrl;

                return `
                    <div class="device-item">
                        <div class="device-icon">
                            ${imagen
                                ? `<img src="${imagen}" style="width:48px;height:48px;border-radius:6px;object-fit:cover;">`
                                : `<i class="bi bi-${getIconoDispositivo(tipo)}"></i>`
                            }
                        </div>
                        <div>
                            <strong>${tipo}</strong><br>
                            ${d.marca ? `<strong>${d.marca}</strong>` : ""} ${d.modelo || ""}<br>
                            <small style="color: #666;">Serial: ${d.serial || "N/A"}</small>
                        </div>
                    </div>
                `;
            }).join("");
        } catch {
            ownerContainer.innerHTML = `<p class="text-danger text-center">Error al cargar dispositivos</p>`;
        }
    }

    // ✅ MOSTRAR PERFIL
    async function showProfile(persona, tipoPersona, proceso, registro) {
        tipoPersonaActual = tipoPersona;
        procesoActualId = proceso.idProceso || proceso.IdProceso;
        modoActual = registro.tipoRegistro || registro.TipoRegistro;
        nombreUsuarioActual = persona.nombreCompleto;

        idPropietarioActual = tipoPersona === "Aprendiz"
            ? (proceso.idAprendiz || proceso.IdAprendiz)
            : (proceso.idUsuario || proceso.IdUsuario);

        const esIngreso = modoActual === "Ingreso";
        const iconoPersona = esIngreso ? "person-check-fill" : "person-dash-fill";
        const colorBadge = esIngreso ? "success" : "warning";
        const iconoBadge = esIngreso ? "🟢" : "🟠";

        profileDiv.innerHTML = `
            <div class="profile-card">
                <div class="profile-avatar">
                    <i class="bi bi-${iconoPersona}"></i>
                </div>
                <div style="flex:1">
                    <strong style="font-size:1.3rem">${persona.nombreCompleto}</strong><br>
                    <span class="badge bg-${colorBadge} fs-6">
                        ${iconoBadge} ${modoActual.toUpperCase()}
                    </span>
                    <div class="profile-details mt-2">
                        📄 ${persona.documento}<br>
                        ✉️ ${persona.correo}<br>
                        ${persona.extra}<br>
                        🧾 Código: ${persona.codigo}
                    </div>
                </div>
            </div>
        `;

        btnAddDevice.disabled = !esIngreso;
        addHistory(modoActual, registro.fechaRegistro || new Date(), persona.nombreCompleto);

        // ✅ VERIFICAR PENDIENTES
        const pendientes = await verificarPendientes();

        // ✅ MOSTRAR ALERTA SI HAY PENDIENTES
        if (pendientes.length > 0) {
            mostrarAlertaPendientes(pendientes);
        }

        // ✅ LÓGICA SEGÚN MODO
        if (esIngreso) {
            await autoRegistrarDispositivos();
        } else {
            await agregarPendientesEnSalida();
        }

        await cargarDispositivosUsuario();
        await cargarDispositivosProceso();

        // Mostrar último detectado
        lastDetected.innerHTML = `
            <div class="d-flex gap-2 align-items-center justify-content-center">
                <div class="device-icon">
                    <i class="bi bi-person-check-fill text-${esIngreso ? "success" : "warning"}" style="font-size:2rem"></i>
                </div>
                <div>
                    <strong>${persona.nombreCompleto}</strong><br>
                    <small class="badge bg-${esIngreso ? "success" : "warning"}">
                        ${iconoBadge} ${modoActual}
                    </small>
                </div>
            </div>
        `;

        showToast(`✔️ ${modoActual} registrado correctamente`, "success");
    }

    function getIconoDispositivo(tipo) {
        const iconos = {
            'Portátil': 'laptop',
            'Computador': 'pc-display',
            'Tablet': 'tablet',
            'Mouse': 'mouse',
            'Teclado': 'keyboard',
            'Cargador': 'plug',
            'Celular': 'phone',
            'USB': 'usb-drive',
            'Monitor': 'display',
            'Impresora': 'printer'
        };
        return iconos[tipo] || "hdd";
    }

    async function removeFromProcess(relId) {
        if (!confirm("¿Quitar este dispositivo del proceso actual?")) return;

        try {
            await safeFetch(API.desvincular(relId), { method: "DELETE" });
            await cargarDispositivosProceso();
            showToast("✔️ Dispositivo removido correctamente", "warning");
        } catch (error) {
            showToast("❌ Error al eliminar el dispositivo", "danger");
        }
    }

    function addHistory(tipo, fecha, nombre) {
        const item = document.createElement("div");
        const esIngreso = tipo === "Ingreso";

        item.className = `history-item ${esIngreso ? "ingreso" : "salida"}`;
        item.innerHTML = `
            <strong>${esIngreso ? "🟢" : "🟠"} ${tipo}</strong> — ${nombre}<br>
            <small>${new Date(fecha).toLocaleString("es-CO")}</small>
        `;

        historyList.prepend(item);
        while (historyList.children.length > 20) historyList.lastChild.remove();
    }

    async function agregarExistenteAlProceso(idElemento) {
        if (!procesoActualId) return;

        try {
            await safeFetch(API.vincular(), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    idElemento,
                    idProceso: procesoActualId,
                    validado: true,
                    quedoEnSena: false
                })
            });

            await cargarDispositivosProceso();
            await cargarDispositivosModal();
            showToast("🟢 Dispositivo agregado al proceso", "success");
        } catch (error) {
            showToast("❌ Error al agregar el dispositivo", "danger");
        }
    }

    // ✅ MODAL - CARGAR AL ABRIR
    document.getElementById("modalAddDevice").addEventListener("show.bs.modal", async () => {
        const modalUserData = document.getElementById("modalUserData");
        modalUserData.innerHTML = `
            <strong>${nombreUsuarioActual}</strong><br>
            <span class="badge bg-primary">${tipoPersonaActual}</span>
        `;
        await cargarDispositivosModal();
        await cargarTiposElemento();
    });

    // ✅ CARGAR TIPOS DE ELEMENTOS EN EL SELECT
    async function cargarTiposElemento() {
        try {
            const res = await safeFetch(API.tipos());
            const tipos = await res.json();

            const selTipoElemento = document.getElementById("selTipoElemento");
            selTipoElemento.innerHTML = tipos.map(t => `
                <option value="${t.idTipoElemento || t.IdTipoElemento}">
                    ${t.tipo || t.Tipo}
                </option>
            `).join("");
        } catch {
            document.getElementById("selTipoElemento").innerHTML = `<option value="">Error al cargar</option>`;
        }
    }

    // ✅ CARGAR DISPOSITIVOS EN EL MODAL
    async function cargarDispositivosModal() {
        const modalUserDevices = document.getElementById("modal-user-devices");

        try {
            const res = await safeFetch(API.owner(tipoPersonaActual, idPropietarioActual));
            const dispositivos = await res.json();

            const resProc = await safeFetch(API.byProceso(procesoActualId));
            const dispositivosProc = resProc.ok ? await resProc.json() : [];
            const idsEnProceso = dispositivosProc.map(ep => ep.idElemento || ep.IdElemento);

            if (dispositivos.length === 0) {
                modalUserDevices.innerHTML = `<p class="text-center text-muted small">Sin dispositivos.</p>`;
                return;
            }

            modalUserDevices.innerHTML = dispositivos.map(d => {
                const tipoElem = d.tipoElemento || d.TipoElemento || {};
                const tipoNombre = tipoElem.tipo || tipoElem.Tipo || "Dispositivo";
                const idElemento = d.idElemento || d.IdElemento;
                const enProceso = idsEnProceso.includes(idElemento);

                return `
                    <div class="device-item">
                        <div class="device-icon">
                            ${d.imagenUrl
                                ? `<img src="${d.imagenUrl}" style="width:48px;height:48px;border-radius:6px;object-fit:cover;">`
                                : `<i class="bi bi-${getIconoDispositivo(tipoNombre)}"></i>`
                            }
                        </div>
                        <div style="flex:1">
                            <strong>${tipoNombre}</strong><br>
                            ${d.marca || ""} ${d.modelo || ""}<br>
                            <small style="color: #666;">Serial: ${d.serial || "N/A"}</small>
                        </div>
                        ${enProceso
                            ? `<span class="badge bg-secondary">En proceso</span>`
                            : `<button class="btn btn-outline-success btn-sm" onclick="agregarExistenteAlProceso(${idElemento})">
                                   <i class="bi bi-plus-circle"></i>
                               </button>`
                        }
                    </div>
                `;
            }).join("");
        } catch (error) {
            modalUserDevices.innerHTML = `<p class="text-danger text-center">Error al cargar</p>`;
        }
    }

    // ✅ GUARDAR NUEVO DISPOSITIVO
    document.getElementById("btnGuardarDevice").onclick = async () => {
        const selTipoElemento = document.getElementById("selTipoElemento");
        const inpSerial = document.getElementById("inpSerial");
        const inpMarca = document.getElementById("inpMarca");
        const inpModelo = document.getElementById("inpModelo");
        const inpDescripcion = document.getElementById("inpDescripcion");

        if (!selTipoElemento.value || !inpSerial.value.trim()) {
            showToast("⚠️ Debes completar los campos: Tipo y Serial", "danger");
            return;
        }

        const payload = {
            idTipoElemento: Number(selTipoElemento.value),
            idPropietario: idPropietarioActual,
            tipoPropietario: tipoPersonaActual,
            marca: inpMarca.value.trim(),
            modelo: inpModelo.value.trim(),
            serial: inpSerial.value.trim().toUpperCase(),
            descripcion: inpDescripcion.value.trim()
        };

        try {
            const res = await safeFetch(API.crearElem(), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const nuevoElemento = await res.json();
            showToast("🟢 Dispositivo creado exitosamente", "success");

            if (modoActual === "Ingreso") {
                await safeFetch(API.vincular(), {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        idElemento: nuevoElemento.idElemento,
                        idProceso: procesoActualId,
                        validado: true,
                        quedoEnSena: false
                    })
                });
            }

            // Limpiar formulario
            inpSerial.value = "";
            inpMarca.value = "";
            inpModelo.value = "";
            inpDescripcion.value = "";

            await cargarDispositivosUsuario();
            await cargarDispositivosProceso();
            await cargarDispositivosModal();

            bootstrap.Modal.getInstance(document.getElementById("modalAddDevice")).hide();
        } catch (error) {
            showToast(error.message || "❌ Error al crear el dispositivo", "danger");
        }
    };

    // ✅ SIGNALR
    const connection = new signalR.HubConnectionBuilder()
        .withUrl(HUB_URL)
        .withAutomaticReconnect([0, 2000, 5000, 10000])
        .build();

    connection.on("OperacionProcesada", async raw => {
        limpiarProceso();

        const payload = typeof raw === "string" ? JSON.parse(raw) : raw;
        const proceso = payload.proceso || payload.Proceso;
        const registro = payload.registro || payload.Registro;

        if (!validarProceso(proceso)) {
            showToast("❌ Proceso inválido recibido", "danger");
            return;
        }

        const tipo = proceso.tipoPersona || proceso.TipoPersona;
        const id = tipo === "Aprendiz"
            ? (proceso.idAprendiz || proceso.IdAprendiz)
            : (proceso.idUsuario || proceso.IdUsuario);

        try {
            const res = await safeFetch(tipo === "Aprendiz" ? API.aprendiz(id) : API.usuario(id));
            const data = await res.json();
            const persona = mapPersona(tipo, data);
            await showProfile(persona, tipo, proceso, registro);
        } catch (error) {
            showToast("❌ Error cargando datos del usuario", "danger");
        }
    });

    connection.start().then(() => {
        showToast("🟢 Sistema NFC conectado y activo", "success");
    });

    connection.onreconnecting(() => showToast("⚠️ Reconectando al servidor...", "warning"));
    connection.onreconnected(() => showToast("✅ Reconexión exitosa", "success"));
    connection.onclose(() => {
        showToast("❌ Conexión perdida. Recargando página...", "danger");
        setTimeout(() => location.reload(), 3000);
    });

    // ✅ BOTONES
    document.getElementById("btnNuevoProceso").addEventListener("click", () => {
        if (procesoActualId && !confirm("¿Deseas iniciar un nuevo proceso? El proceso actual se cerrará.")) return;
        limpiarProceso();
        showToast("🔄 Esperando nuevo escaneo NFC...", "info");
    });

</script>
