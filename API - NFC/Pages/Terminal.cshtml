@page
@model API___NFC.Pages.TerminalModel
@{
    ViewData["Title"] = "NFC HUB (Terminal)";
    Layout = "_AdminLayout";
}

<style>
    :root {
        --sena-verde: #39A900;
        --sena-verde-osc: #2d8700;
        --sena-azul: #0B7CBD;
        --sena-amarillo: #FFC300;
        --sena-naranja: #FF6600;
        --borde-suave: #e1e8ed;
        --fondo: #f5f8fa;
        --texto: #1a1a1a;
        --sombra: 0 2px 8px rgba(0,0,0,0.08);
    }

    body {
        background: var(--fondo);
    }

    .card {
        border-radius: 16px;
        box-shadow: var(--sombra);
        border: none;
        overflow: hidden;
        transition: .3s;
    }

        .card:hover {
            transform: translateY(-2px);
        }

    .card-header {
        font-weight: 700;
        border: none;
        background: linear-gradient(135deg,var(--sena-verde),var(--sena-azul));
        color: white;
    }

    #history-list {
        max-height: 80vh;
        overflow-y: auto;
    }

    .history-item {
        background: #fff;
        border-left: 5px solid var(--sena-azul);
        margin-bottom: .5rem;
        border-radius: 8px;
        padding: .75rem;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

        .history-item.ingreso {
            border-left-color: var(--sena-verde);
        }

        .history-item.salida {
            border-left-color: var(--sena-naranja);
        }

    .profile-card {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .profile-avatar {
        width: 90px;
        height: 90px;
        border-radius: 20px;
        background: linear-gradient(135deg,var(--sena-verde),var(--sena-azul));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2.5rem;
        overflow: hidden;
    }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .profile-name {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: .3rem;
    }

    .profile-role {
        color: var(--sena-verde);
        font-weight: 600;
        text-transform: uppercase;
        font-size: .85rem;
    }

    .profile-program {
        background: #f9fafb;
        border-left: 4px solid var(--sena-verde);
        border-radius: 12px;
        padding: .75rem 1rem;
        margin-top: 1rem;
        font-size: .9rem;
    }

    #last-detected-item-content .element-item {
        border: 2px solid var(--sena-azul);
        border-radius: 12px;
        background: linear-gradient(135deg,#e3f2fd,#e8f5e9);
        padding: 1rem;
        margin: 0;
    }

    .device-item {
        display: flex;
        gap: .75rem;
        align-items: center;
        border: 1px solid var(--borde-suave);
        border-radius: 12px;
        padding: .6rem .75rem;
        background: #fff;
        margin: .5rem 0;
    }

        .device-item img {
            width: 56px;
            height: 56px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid var(--borde-suave);
        }

    .toast {
        border: none;
        border-radius: 12px;
        box-shadow: var(--sombra);
    }
</style>

<div class="container-fluid py-4">
    <div class="row g-3">
        <!-- Panel izquierdo: historial -->
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-header text-center"><i class="bi bi-clock-history me-2"></i>Historial</div>
                <div class="card-body" id="history-list">
                    <p class="text-muted small text-center mt-3">Sin registros</p>
                </div>
            </div>
        </div>

        <!-- Panel derecho principal -->
        <div class="col-md-9 d-flex flex-column gap-3">
            <!-- Perfil -->
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0 text-success"><i class="bi bi-person-badge me-2"></i>Perfil</h5>
                    <button id="btnNuevoProceso" class="btn btn-success d-flex align-items-center gap-2">
                        <i class="bi bi-broadcast-pin"></i> Iniciar Proceso
                    </button>
                </div>
                <div id="user-profile-content" class="p-2 text-muted">Esperando lectura...</div>
            </div>

            <!-- Dispositivos del proceso -->
            <div class="card">
                <div class="card-header text-center" style="background:linear-gradient(135deg,var(--sena-verde),#4bbb3f)">
                    Dispositivos en este proceso
                </div>
                <div class="card-body">
                    <div id="user-devices">
                        <p class="text-muted text-center">Sin dispositivos asociados.</p>
                    </div>
                    <div class="text-center mt-2">
                        <button id="btnAddDevice" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalAddDevice" disabled>
                            <i class="bi bi-plus-circle"></i> Agregar dispositivo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Último elemento detectado -->
            <div class="card">
                <div class="card-header text-center" style="background:linear-gradient(135deg,var(--sena-azul),#1e88e5)">
                    Último Elemento Detectado
                </div>
                <div class="card-body" id="last-detected-item-content">
                    <p class="text-center text-muted">Esperando escaneo...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div id="toast-container" style="position:fixed;bottom:1rem;right:1rem;z-index:1050;"></div>
</div>

<!-- MODAL: Agregar Dispositivo (SIN NFC) -->
<div class="modal fade" id="modalAddDevice" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background:linear-gradient(135deg,var(--sena-azul),#1e88e5); color:#fff;">
                <h5 class="modal-title"><i class="bi bi-pc me-2"></i>Agregar dispositivo al proceso</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="formDevice" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Tipo de dispositivo</label>
                        <select id="selTipoElemento" class="form-select" required>
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Serial (obligatorio)</label>
                        <input id="inpSerial" class="form-control" placeholder="Ej. HP-SN-12345" required />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Marca</label>
                        <input id="inpMarca" class="form-control" placeholder="Ej. HP / Logitech / Lenovo" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Modelo</label>
                        <input id="inpModelo" class="form-control" placeholder="Ej. ProBook 440 / G203 / ThinkPad" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">Descripción</label>
                        <input id="inpDescripcion" class="form-control" placeholder="Descripción breve (opcional)" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">URL de imagen (opcional)</label>
                        <input id="inpImagenUrl" class="form-control" placeholder="https://..." />
                    </div>
                </form>

                <div class="small text-muted mt-2">
                    * Este registro <b>NO</b> solicita NFC. Puedes agregar etiquetas más tarde desde Gestión NFC si lo requieres.
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnGuardarDevice" type="button" class="btn btn-success">
                    <i class="bi bi-check2-circle me-1"></i> Guardar
                </button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- SignalR del paquete local (NuGet/npm copiado a wwwroot/lib) -->
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>

    <script>
        // =======================
        // Config & Estado
        // =======================
        const HUB_URL = `${window.location.origin}/nfcHub`;
        const API = {
            aprendiz:  id => `${window.location.origin}/api/Aprendiz/${id}`,
            usuario:   id => `${window.location.origin}/api/Usuario/${id}`,
            tipos:     ()  => `${window.location.origin}/api/TipoElementoes`,
            crearElem: ()  => `${window.location.origin}/api/Elementoes`,
            byProceso: idp => `${window.location.origin}/api/ElementoProcesoes/byProceso/${idp}`,
            vincular:  ()  => `${window.location.origin}/api/ElementoProcesoes`
        };

        let procesoActualId = null;          // para vincular ElementoProceso
        let tipoPersonaActual = null;        // "Aprendiz" | "Usuario"
        let idPropietarioActual = null;      // idAprendiz | idUsuario (según tipo)
        let tiposElementoCache = [];         // cache de tipos

        const connection = new signalR.HubConnectionBuilder()
            .withUrl(HUB_URL)
            .withAutomaticReconnect()
            .build();

        // =======================
        // UI helpers
        // =======================
        const historyList = document.getElementById("history-list");
        const profileDiv = document.getElementById("user-profile-content");
        const lastDetected = document.getElementById("last-detected-item-content");
        const btnLectura = document.getElementById("btnNuevoProceso");
        const btnAddDevice = document.getElementById("btnAddDevice");

        const showToast = (msg, type='info')=>{
            const el=document.createElement('div');
            el.className=`toast align-items-center text-bg-${type} show`;
            el.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
            document.getElementById("toast-container").appendChild(el);
            setTimeout(()=>el.remove(),4000);
        }

        const addHistory = (tipo,fecha,nombre)=>{
            const el=document.createElement('div');
            el.className=`history-item ${ (tipo||'').toLowerCase() }`;
            const fechaTxt = fecha ? new Date(fecha).toLocaleString() : new Date().toLocaleString();
            el.innerHTML=`<strong>${tipo}</strong> — ${nombre || '—'}<br><small>${fechaTxt}</small>`;
            historyList.prepend(el);
        }

        async function showProfile(persona, tipoPersona, proceso, registro) {
            procesoActualId = (proceso.idProceso ?? proceso.IdProceso ?? null);
            tipoPersonaActual = tipoPersona;
            idPropietarioActual = (tipoPersona === 'Aprendiz')
                ? (proceso.idAprendiz ?? proceso.IdAprendiz ?? null)
                : (proceso.idUsuario  ?? proceso.IdUsuario  ?? null);

            const tipoReg = registro.tipoRegistro ?? registro.TipoRegistro ?? 'Ingreso';
            const fechaReg = registro.fechaRegistro ?? registro.FechaRegistro ?? new Date();

            profileDiv.innerHTML = `
                <div class="profile-card">
                    <div class="profile-avatar">
                        ${persona.fotoUrl ? `<img src="${persona.fotoUrl}" alt="Foto">` : `<i class="bi bi-person-circle"></i>`}
                    </div>
                    <div class="profile-info">
                        <p class="profile-role">${tipoPersona}</p>
                        <h4 class="profile-name">${persona.nombreCompleto}</h4>
                        <p class="text-muted">${tipoReg} — ${new Date(fechaReg).toLocaleString()}</p>
                        <div class="profile-program">
                            📄 ${persona.documento || '—'}<br>
                            ✉️ ${persona.correo || '—'}<br>
                            🎓 ${persona.extra || '—'}<br>
                            🧾 Código: ${persona.codigoBarras || '—'}<br>
                            ⚙️ Proceso: ${procesoActualId || '—'}
                        </div>
                    </div>
                </div>
            `;

            // habilitar botón de agregar dispositivo si ya hay proceso
            btnAddDevice.disabled = !procesoActualId;

            // cargar dispositivos del proceso
            await cargarDispositivos(procesoActualId);
        }

        async function cargarDispositivos(idProceso) {
            const cont = document.getElementById("user-devices");
            if (!idProceso) {
                cont.innerHTML = `<p class="text-muted text-center">Sin dispositivos asociados.</p>`;
                return;
            }

            const res = await fetch(API.byProceso(idProceso));
            if (!res.ok) {
                cont.innerHTML = `
                    <div class="text-center">
                        <p class="text-muted">Sin dispositivos asociados.</p>
                    </div>`;
                return;
            }

            const data = await res.json();
            if (!data || data.length === 0) {
                cont.innerHTML = `<p class="text-muted text-center">Sin dispositivos registrados aún.</p>`;
                return;
            }

            cont.innerHTML = data.map(d => `
                <div class="device-item">
                    <img src="${d.elemento?.imagenUrl || '/img/default-device.png'}" alt="Foto">
                    <div>
                        <strong>${d.elemento?.descripcion || d.elemento?.marca || 'Dispositivo'}</strong><br>
                        <small>${d.elemento?.modelo || ''} — ${d.elemento?.serial || ''}</small>
                    </div>
                </div>
            `).join('');
        }

        const updateLastDetected = (tipo, persona)=>{
            const tipoTxt = tipo ?? 'Ingreso';
            lastDetected.innerHTML=`
                <div class="element-item highlighted">
                    <img src="${persona.fotoUrl || '/img/default-user.png'}" class="element-image" alt="Foto">
                    <div class="element-details">
                        <strong>${persona.nombreCompleto}</strong>
                        <p>${tipoTxt} — ${new Date().toLocaleTimeString()}</p>
                        <p>${persona.documento || ''}</p>
                    </div>
                </div>`;
        }

        const mapPersona=(tipo,data)=>{
            if((tipo||'')==='Aprendiz'){
                return {
                    id: data.idAprendiz ?? data.IdAprendiz,
                    nombreCompleto:`${data.nombre||data.Nombre||''} ${data.apellido||data.Apellido||''}`.trim(),
                    documento:`${data.tipoDocumento||data.TipoDocumento||''} ${data.numeroDocumento||data.NumeroDocumento||''}`.trim(),
                    correo: data.correo || data.Correo || '',
                    extra: (data.ficha?.codigo || data.Ficha?.Codigo) ? `Ficha ${data.ficha?.codigo ?? data.Ficha?.Codigo}` : '',
                    codigoBarras: data.codigoBarras || data.CodigoBarras || '',
                    fotoUrl: data.fotoUrl || data.FotoUrl || null
                };
            } else {
                return {
                    id: data.idUsuario ?? data.IdUsuario,
                    nombreCompleto:`${data.nombre||data.Nombre||''} ${data.apellido||data.Apellido||''}`.trim(),
                    documento:`${data.tipoDocumento||data.TipoDocumento||''} ${data.numeroDocumento||data.NumeroDocumento||''}`.trim(),
                    correo: data.correo || data.Correo || '',
                    extra: data.rol || data.Rol || '',
                    codigoBarras: data.codigoBarras || data.CodigoBarras || '',
                    fotoUrl: data.fotoUrl || data.FotoUrl || null
                };
            }
        }

        // =======================
        // SignalR: eventos del Hub
        // =======================
        connection.on("OperacionProcesada", async (json)=>{
            try{
                // payload puede venir camelCase o PascalCase según AddJsonOptions (ya lo normalizamos)
                const payload = (typeof json === 'string') ? JSON.parse(json) : json;
                const proceso = payload.proceso ?? payload.Proceso ?? {};
                const registro = payload.registro ?? payload.Registro ?? {};
                const tipoPersona = proceso.tipoPersona ?? proceso.TipoPersona ?? 'Usuario';
                const id = (tipoPersona === "Aprendiz")
                    ? (proceso.idAprendiz ?? proceso.IdAprendiz)
                    : (proceso.idUsuario  ?? proceso.IdUsuario);

                // traer datos reales de la persona
                const res = await fetch(tipoPersona === "Aprendiz" ? API.aprendiz(id) : API.usuario(id));
                if(!res.ok) throw new Error("No se pudo obtener los datos de la persona");
                const persona = mapPersona(tipoPersona, await res.json());

                showProfile(persona, tipoPersona, proceso, registro);
                const tipoReg = registro.tipoRegistro ?? registro.TipoRegistro ?? 'Ingreso';
                const fechaReg = registro.fechaRegistro ?? registro.FechaRegistro ?? new Date();
                updateLastDetected(tipoReg, persona);
                addHistory(tipoReg, fechaReg, persona.nombreCompleto);
                showToast(`✅ ${tipoReg} de ${persona.nombreCompleto}`,"success");
            }catch(e){
                console.error(e);
                showToast("Error procesando lectura","danger");
            }
        });

        connection.on("OperacionError", msg => showToast("⚠️ " + msg, "danger"));
        connection.on("AgentStatusUpdate", (msg, type) => showToast(msg, type === 'warning' ? 'danger' : 'info'));

        // =======================
        // Botones / acciones
        // =======================
        btnLectura.addEventListener("click", async ()=>{
            try{
                await connection.invoke("SetAgentModeToRead");
                showToast("📶 Modo lectura activo. Pase un tag...", "info");
            }catch{
                showToast("No se pudo poner el agente en modo lectura","danger");
            }
        });

        // Cargar tipos al abrir el modal
        const modalAdd = document.getElementById('modalAddDevice');
        modalAdd.addEventListener('show.bs.modal', async ()=>{
            const sel = document.getElementById('selTipoElemento');
            // evita recargar si ya los tenemos
            if (tiposElementoCache.length === 0) {
                sel.innerHTML = `<option value="">Cargando...</option>`;
                try{
                    const r = await fetch(API.tipos());
                    if (!r.ok) throw 0;
                    const data = await r.json();
                    tiposElementoCache = data || [];
                }catch {
                    tiposElementoCache = [];
                }
            }
            if (tiposElementoCache.length === 0) {
                sel.innerHTML = `<option value="">(No hay tipos activos)</option>`;
            } else {
                sel.innerHTML = `<option value="">Seleccione...</option>` + tiposElementoCache.map(t =>
                    `<option value="${t.idTipoElemento ?? t.IdTipoElemento}">${t.tipo ?? t.Tipo}</option>`
                ).join('');
            }
        });

        // Guardar dispositivo (sin NFC) y vincular al proceso
        document.getElementById('btnGuardarDevice').addEventListener('click', async ()=>{
            if (!procesoActualId || !idPropietarioActual || !tipoPersonaActual) {
                showToast("No hay proceso en curso. Pase un tag primero.","danger");
                return;
            }

            const selTipo = document.getElementById('selTipoElemento');
            const serial  = document.getElementById('inpSerial').value.trim();
            const marca   = document.getElementById('inpMarca').value.trim();
            const modelo  = document.getElementById('inpModelo').value.trim();
            const descripcion = document.getElementById('inpDescripcion').value.trim();
            const imagenUrl   = document.getElementById('inpImagenUrl').value.trim();

            if (!selTipo.value) { showToast("Seleccione el tipo de dispositivo","danger"); return; }
            if (!serial)        { showToast("El serial es obligatorio","danger"); return; }

            // Elemento requiere: IdTipoElemento, IdPropietario, TipoPropietario, Serial (obligatorio), opcionales…
            const elementoPayload = {
                idTipoElemento: Number(selTipo.value),
                idPropietario: Number(idPropietarioActual),
                tipoPropietario: tipoPersonaActual, // "Aprendiz" o "Usuario" (cumple CHECK)
                marca: marca || null,
                modelo: modelo || null,
                serial: serial,
                codigoNFC: null,         // SIN NFC
                descripcion: descripcion || null,
                imagenUrl: imagenUrl || null,
                estado: true
            };

            try{
                // 1) Crear Elemento
                const r1 = await fetch(API.crearElem(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(elementoPayload)
                });
                if (!r1.ok) {
                    const txt = await r1.text();
                    showToast(`Error creando elemento: ${txt}`, 'danger');
                    return;
                }
                const elem = await r1.json();
                const idElemento = elem.idElemento ?? elem.IdElemento;

                // 2) Vincular Elemento a Proceso
                const vincPayload = {
                    idElemento: idElemento,
                    idProceso:  Number(procesoActualId),
                    validado: true
                };
                const r2 = await fetch(API.vincular(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(vincPayload)
                });
                if (!r2.ok) {
                    const txt = await r2.text();
                    showToast(`Elemento creado, pero error al vincular: ${txt}`, 'danger');
                } else {
                    showToast("✅ Dispositivo agregado al proceso", "success");
                }

                // 3) Refrescar listado y cerrar modal
                await cargarDispositivos(procesoActualId);
                const modal = bootstrap.Modal.getInstance(modalAdd);
                modal.hide();
                // limpiar form
                document.getElementById('formDevice').reset();

            }catch(e){
                console.error(e);
                showToast("Error al guardar el dispositivo", 'danger');
            }
        });

        // =======================
        // Arranque SignalR
        // =======================
        async function startHub(){
            try{
                await connection.start();
                showToast("Conectado al Hub NFC","success");
            }catch(e){
                console.error(e);
                showToast("No se pudo conectar al Hub","danger");
                setTimeout(startHub,4000);
            }
        }
        startHub();
    </script>
}
