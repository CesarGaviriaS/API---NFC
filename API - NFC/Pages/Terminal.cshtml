@page
@model API___NFC.Pages.TerminalModel
@{
    ViewData["Title"] = "NFC HUB (Terminal)";
    Layout = "_AdminLayout";
}

<style>
    :root {
        --sena-verde: #39A900;
        --sena-azul: #0B7CBD;
        --sena-naranja: #FF6600;
        --borde-suave: #dee2e6;
        --fondo: #f8f9fa;
        --texto: #212529;
        --sombra: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
        --radio: 0.75rem;
    }

    body {
        background-color: var(--fondo);
        font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        color: var(--texto);
    }

    .card {
        border-radius: var(--radio);
        box-shadow: var(--sombra);
        transition: all 0.2s ease-in-out;
    }

        .card:hover {
            transform: translateY(-2px);
        }

    .card-header {
        font-weight: 600;
        border: none;
        color: #fff;
        padding: 1rem;
        font-size: 1rem;
    }

        .card-header.blue {
            background: linear-gradient(135deg, var(--sena-azul), #1d7ed6);
        }

        .card-header.green {
            background: linear-gradient(135deg, var(--sena-verde), #4bbb3f);
        }

    .profile-card {
        display: flex;
        gap: 1rem;
        align-items: center;
        padding: 1rem;
    }

    .profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 1rem;
        background: linear-gradient(135deg, var(--sena-verde), var(--sena-azul));
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2rem;
        color: #fff;
        box-shadow: var(--sombra);
        border: 3px solid #fff;
    }

    .profile-details {
        background: #fff;
        border-left: 4px solid var(--sena-verde);
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        line-height: 1.6;
    }

    .device-item {
        display: flex;
        background: #fff;
        padding: 1rem;
        border-radius: var(--radio);
        border: 1px solid var(--borde-suave);
        margin-bottom: 0.75rem;
        gap: 1rem;
        align-items: center;
        transition: 0.2s ease;
    }

        .device-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra);
        }

    .device-icon {
        width: 48px;
        height: 48px;
        border-radius: 0.5rem;
        background: #e7f1fa;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        color: var(--sena-azul);
    }

    .device-name {
        font-weight: 600;
        color: var(--sena-azul);
    }

    .device-details {
        font-size: 0.85rem;
        color: #6c757d;
    }

    #history-list {
        max-height: 80vh;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .history-item {
        padding: 0.75rem 1rem;
        background: #fff;
        border-radius: 0.5rem;
        border-left: 4px solid var(--sena-azul);
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }

        .history-item.ingreso {
            border-left-color: var(--sena-verde);
        }

        .history-item.salida {
            border-left-color: var(--sena-naranja);
        }

    .toast {
        border-radius: 0.75rem;
        box-shadow: var(--sombra);
    }

    button.btn {
        border-radius: 0.5rem;
        font-weight: 500;
        transition: transform 0.15s ease-in-out;
    }

        button.btn:hover {
            transform: scale(1.03);
        }

    input.form-control,
    select.form-select {
        border-radius: 0.5rem;
        box-shadow: none;
        transition: border-color 0.2s ease;
    }

        input.form-control:focus,
        select.form-select:focus {
            border-color: var(--sena-azul);
            outline: none;
        }

    /* MODAL */
    .modal-header {
        background: var(--sena-azul);
        color: #fff;
        border-top-left-radius: var(--radio);
        border-top-right-radius: var(--radio);
    }

    .modal-body h6 {
        font-weight: 600;
        color: var(--sena-azul);
    }
    /* MODAL DISEÑO MEJORADO */
    .modal-content {
        border-radius: 0.75rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        overflow: hidden;
    }

    .modal-header {
        background: var(--sena-azul);
        color: #fff;
        border-bottom: none;
        padding: 1rem 1.25rem;
    }

        .modal-header h5 {
            margin: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

    .modal-body {
        background: #f8f9fa;
        padding: 1.5rem;
    }

        .modal-body h6 {
            font-weight: 600;
            font-size: 1rem;
            color: var(--sena-azul);
            margin-bottom: 0.5rem;
        }

    .modal-footer {
        background-color: #f1f1f1;
        border-top: none;
        padding: 1rem 1.25rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    /* Caja usuario */
    #modalUserData {
        background-color: #e7f3ff;
        border-left: 4px solid var(--sena-azul);
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
    }

    /* Lista dispositivos existentes */
    #modal-user-devices {
        background: #fff;
        border: 1px solid var(--borde-suave);
        border-radius: 0.5rem;
        padding: 0.75rem;
    }

    /* Inputs */
    input.form-control,
    select.form-select {
        border-radius: 0.5rem;
        border: 1px solid #ced4da;
        box-shadow: none;
    }

        input.form-control:focus,
        select.form-select:focus {
            border-color: var(--sena-azul);
            outline: none;
        }

    /* Botones */
    .modal-footer .btn {
        padding: 0.5rem 1.25rem;
        font-weight: 500;
        border-radius: 0.5rem;
    }

    /* Oculta el contenido mientras se valida el rol para evitar parpadeos */
    html.guard-check-pending {
        visibility: hidden;
    }
</style>

<div class="container-fluid py-4">

    <!-- PERFIL (PARTE SUPERIOR) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="text-success"><i class="bi bi-person-badge"></i> Perfil</h5>
                    <button id="btnNuevoProceso" class="btn btn-success">
                        <i class="bi bi-broadcast-pin"></i> Iniciar lectura
                    </button>
                </div>
                <div id="user-profile-content" class="mt-2 text-muted">
                    Esperando lectura...
                </div>
            </div>
        </div>
    </div>

    <!-- FILA INFERIOR: HISTORIAL + DISPOSITIVOS -->
    <div class="row g-3">

        <!-- HISTORIAL -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header blue text-center">
                    <i class="bi bi-clock-history"></i> Historial
                </div>
                <div id="history-list" class="card-body">
                    <p class="text-center text-muted small">Sin registros</p>
                </div>
            </div>
        </div>

        <!-- DISPOSITIVOS DEL USUARIO -->
        <div class="col-md-4">
            <div class="card h-100 p-3">
                <h5 class="text-primary"><i class="bi bi-hdd"></i> Dispositivos del Usuario</h5>
                <div id="user-owner-devices">
                    <p class="text-center text-muted">Sin dispositivos.</p>
                </div>
            </div>
        </div>

        <!-- DISPOSITIVOS EN PROCESO -->
        <div class="col-md-4">
            <div class="card h-100 p-3">
                <h5 class="text-primary"><i class="bi bi-cpu"></i> Dispositivos en Proceso</h5>
                <div id="user-process-devices">
                    <p class="text-center text-muted">No hay dispositivos en proceso.</p>
                </div>

                <div class="text-center mt-2">
                    <button id="btnAddDevice" class="btn btn-outline-success"
                            data-bs-toggle="modal"
                            data-bs-target="#modalAddDevice" disabled>
                        <i class="bi bi-plus-circle"></i> Agregar dispositivo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÚLTIMO DETECTADO (DEBAJO DE TODO) -->
    <div class="row g-3 mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header blue text-center">Último Detectado</div>
                <div id="last-detected-item-content" class="card-body text-center">
                    <p class="text-muted">Esperando escaneo...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TOASTS -->
    <div id="toast-container" style="position:fixed;bottom:1rem;right:1rem;z-index:2000;"></div>
</div>

<!-- MODAL REGISTRAR DISPOSITIVO (100% Bootstrap) -->
<div class="modal fade" id="modalAddDevice" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <!-- Encabezado -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title d-flex align-items-center gap-2">
                    <i class="bi bi-pc"></i> Registrar dispositivo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <!-- Cuerpo -->
            <div class="modal-body bg-light">

                <!-- Datos del usuario -->
                <div class="alert alert-info border-start border-4 border-primary rounded-3">
                    <h6 class="mb-1"><i class="bi bi-person-lines-fill"></i> Usuario</h6>
                    <div id="modalUserData" class="small text-muted">Cargando...</div>
                </div>

                <!-- Dispositivos existentes -->
                <h6 class="text-primary mb-2"><i class="bi bi-hdd-network"></i> Dispositivos existentes</h6>
                <div id="modal-user-devices" class="bg-white border rounded p-3 mb-3" style="max-height:200px; overflow-y:auto;">
                    <p class="text-center text-muted small">Sin dispositivos.</p>
                </div>

                <hr>

                <!-- Formulario nuevo dispositivo -->
                <h6 class="text-success"><i class="bi bi-plus-circle"></i> Crear nuevo dispositivo</h6>
                <form id="formDevice" class="row g-3 mt-2">

                    <div class="col-md-6">
                        <label for="selTipoElemento" class="form-label">Tipo *</label>
                        <select id="selTipoElemento" class="form-select" required>
                            <option value="">Cargando...</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="inpSerial" class="form-label">Serial *</label>
                        <input id="inpSerial" type="text" class="form-control" required>
                    </div>

                    <div class="col-md-6">
                        <label for="inpMarca" class="form-label">Marca</label>
                        <input id="inpMarca" type="text" class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label for="inpModelo" class="form-label">Modelo</label>
                        <input id="inpModelo" type="text" class="form-control">
                    </div>

                    <div class="col-12">
                        <label for="inpDescripcion" class="form-label">Descripción</label>
                        <input id="inpDescripcion" type="text" class="form-control">
                    </div>

                </form>

            </div>

            <!-- Footer -->
            <div class="modal-footer bg-white">
                <button id="btnGuardarDevice" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> Guardar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>

        </div>
    </div>
</div>


<script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>

<script>
    (() => {
        document.documentElement.classList.add('guard-check-pending');

        function decodeJwt(token) {
            if (!token) return null;
            const parts = token.split('.');
            if (parts.length !== 3) return null;
            try {
                const payload = parts[1].replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(atob(payload));
            } catch {
                return null;
            }
        }

        function obtenerRolActivo() {
            const rawToken = localStorage.getItem('auth_token');
            const decoded = decodeJwt(rawToken);
            let localUser = null;
            const storedUser = localStorage.getItem('user_info');

            if (storedUser) {
                try {
                    localUser = JSON.parse(storedUser);
                } catch {
                    localUser = null;
                }
            }

            const rol = decoded?.role
                || decoded?.Rol
                || decoded?.["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"]
                || localUser?.Rol
                || localUser?.rol
                || null;

            return typeof rol === 'string' ? rol.trim().toLowerCase() : null;
        }

        const rolActivo = obtenerRolActivo();
        if (rolActivo !== 'guardia') {
            window.location.replace('/Admin/Usuarios');
            return;
        }

        document.documentElement.classList.remove('guard-check-pending');
    })();
</script>
<script>
    /* =============================================================================
       🎯 CONFIGURACIÓN Y VARIABLES GLOBALES
    ============================================================================= */

    const HUB_URL = `${window.location.origin}/nfcHub`;

    const API = {
        aprendiz: id => `/api/Aprendiz/${id}`,
        usuario: id => `/api/Usuario/${id}`,
        tipos: () => `/api/TipoElementoes`,
        owner: (tipo, id) => `/api/Elementoes/byOwner/${tipo}/${id}`,
        crearElem: () => `/api/Elementoes`,
        byProceso: (p) => `/api/ElementoProcesoes/byProceso/${p}`,
        autoRegister: () => `/api/ElementoProcesoes/autoRegister`,
        vincular: () => `/api/ElementoProcesoes`,
        desvincular: id => `/api/ElementoProcesoes/${id}`,
        procesoActivo: (tipo, id) => `/api/Procesoes/activo/${tipo}/${id}`
    };

    // 🔥 Variables de estado del proceso actual
    let procesoActualId = null;
    let tipoPersonaActual = null;
    let idPropietarioActual = null;
    let modoActual = null; // "Ingreso" o "Salida"
    let nombreUsuarioActual = null;

    /* =============================================================================
       🎨 ELEMENTOS DOM
    ============================================================================= */

    const ownerContainer = document.getElementById("user-owner-devices");
    const processContainer = document.getElementById("user-process-devices");
    const profileDiv = document.getElementById("user-profile-content");
    const lastDetected = document.getElementById("last-detected-item-content");
    const historyList = document.getElementById("history-list");
    const btnAddDevice = document.getElementById("btnAddDevice");
    const modalUserData = document.getElementById("modalUserData");
    const modalUserDevices = document.getElementById("modal-user-devices");
    const selTipoElemento = document.getElementById("selTipoElemento");
    const inpSerial = document.getElementById("inpSerial");
    const inpMarca = document.getElementById("inpMarca");
    const inpModelo = document.getElementById("inpModelo");
    const inpDescripcion = document.getElementById("inpDescripcion");

    /* =============================================================================
       🍞 SISTEMA DE TOASTS
    ============================================================================= */

    function showToast(msg, type = "info") {
        const div = document.createElement("div");
        div.className = `toast text-bg-${type} show`;
        div.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${msg}</div>
                <button class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        document.getElementById("toast-container").appendChild(div);
        setTimeout(() => div.remove(), 5000);
    }

    /* =============================================================================
       🧹 LIMPIAR PROCESO
    ============================================================================= */

    function limpiarProceso() {
        procesoActualId = null;
        tipoPersonaActual = null;
        idPropietarioActual = null;
        modoActual = null;
        nombreUsuarioActual = null;

        ownerContainer.innerHTML = `<p class="text-center text-muted">Sin dispositivos.</p>`;
        processContainer.innerHTML = `<p class="text-center text-muted">No hay dispositivos en proceso.</p>`;
        profileDiv.innerHTML = `<div class="text-muted">Esperando lectura...</div>`;
        lastDetected.innerHTML = `<p class="text-muted">Esperando escaneo...</p>`;
        btnAddDevice.disabled = true;
    }

    /* =============================================================================
       ✅ VALIDACIÓN DEL PROCESO
    ============================================================================= */

    function validarProceso(proceso) {
        if (!proceso) return false;
        const tipo = proceso.tipoPersona || proceso.TipoPersona;
        if (tipo === "Aprendiz") return !!(proceso.idAprendiz || proceso.IdAprendiz);
        if (tipo === "Usuario") return !!(proceso.idUsuario || proceso.IdUsuario);
        return false;
    }

    /* =============================================================================
       👤 MAPEAR PERSONA (Aprendiz o Usuario)
    ============================================================================= */

    function mapPersona(tipo, data) {
        const nombre = data.nombre || data.Nombre || "";
        const apellido = data.apellido || data.Apellido || "";
        const tipoDoc = data.tipoDocumento || data.TipoDocumento || "";
        const numDoc = data.numeroDocumento || data.NumeroDocumento || "";
        const correo = data.correo || data.Correo || "";
        const codigo = data.codigoBarras || data.CodigoBarras || "N/A";

        let extra = "";
        if (tipo === "Aprendiz") {
            const fichaData = data.ficha || data.Ficha;
            const codigoFicha = fichaData?.codigo || fichaData?.Codigo || "N/A";
            const programaData = fichaData?.programa || fichaData?.Programa;
            const nombrePrograma = programaData?.nombrePrograma || programaData?.NombrePrograma || "N/A";
            extra = `🎓 Aprendiz<br>📚 Ficha: ${codigoFicha}<br>🎯 ${nombrePrograma}`;
        } else {
            const rol = data.rol || data.Rol || "Funcionario";
            const cargo = data.cargo || data.Cargo;
            extra = `👔 ${rol}${cargo ? `<br>💼 ${cargo}` : ''}`;
        }

        return {
            nombreCompleto: `${nombre} ${apellido}`,
            documento: `${tipoDoc} ${numDoc}`,
            correo: correo,
            codigo: codigo,
            extra: extra
        };
    }

    /* =============================================================================
       🤖 AUTO-REGISTRAR DISPOSITIVOS (SOLO EN INGRESO)
    ============================================================================= */

    async function autoRegistrarDispositivos() {
        if (modoActual !== "Ingreso") {
            console.log("⏭️ Modo Salida detectado - No se auto-registran dispositivos");
            return;
        }

        console.log("🤖 Iniciando auto-registro de dispositivos...");

        try {
            const response = await fetch(API.autoRegister(), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    idProceso: procesoActualId,
                    tipoPropietario: tipoPersonaActual,
                    idPropietario: idPropietarioActual
                })
            });

            if (response.ok) {
                const result = await response.json();
                console.log(`✅ Auto-registro completado:`, result);

                if (result.registrados > 0) {
                    showToast(`✅ ${result.registrados} dispositivo(s) registrado(s) automáticamente`, "success");
                } else {
                    console.log("ℹ️ No hay dispositivos nuevos para registrar");
                }

                await cargarDispositivosProceso();
            } else {
                console.error("❌ Error en auto-registro:", response.statusText);
            }
        } catch (error) {
            console.error("❌ Excepción en auto-registro:", error);
        }
    }

    /* =============================================================================
       📊 MOSTRAR PERFIL + ACTIVAR PROCESO
    ============================================================================= */

    async function showProfile(persona, tipoPersona, proceso, registro) {
        tipoPersonaActual = tipoPersona;
        procesoActualId = proceso.idProceso || proceso.IdProceso;
        modoActual = registro.tipoRegistro || registro.TipoRegistro;
        nombreUsuarioActual = persona.nombreCompleto;

        idPropietarioActual = tipoPersona === "Aprendiz"
            ? (proceso.idAprendiz || proceso.IdAprendiz)
            : (proceso.idUsuario || proceso.IdUsuario);

        console.log(`🎯 Proceso activado: ID=${procesoActualId}, Modo=${modoActual}, Tipo=${tipoPersona}, Propietario=${idPropietarioActual}`);

        const esIngreso = modoActual === "Ingreso";
        const iconoPersona = esIngreso ? "person-check-fill" : "person-dash-fill";
        const colorBadge = esIngreso ? "success" : "warning";
        const iconoBadge = esIngreso ? "🟢" : "🟠";

        profileDiv.innerHTML = `
            <div class="profile-card">
                <div class="profile-avatar">
                    <i class="bi bi-${iconoPersona}"></i>
                </div>
                <div style="flex:1">
                    <strong style="font-size:1.3rem">${persona.nombreCompleto}</strong><br>
                    <span class="badge bg-${colorBadge} fs-6">
                        ${iconoBadge} ${modoActual.toUpperCase()}
                    </span>
                    <div class="profile-details mt-2">
                        📄 ${persona.documento}<br>
                        ✉️ ${persona.correo}<br>
                        ${persona.extra}<br>
                        🧾 Código: ${persona.codigo}
                    </div>
                </div>
            </div>
        `;

        // 🔒 Solo permitir agregar dispositivos en INGRESO
        btnAddDevice.disabled = !esIngreso;

        addHistory(modoActual, registro.fechaRegistro || new Date(), persona.nombreCompleto);

        // 🔥 AUTO-REGISTRAR DISPOSITIVOS (solo en ingreso)
        await autoRegistrarDispositivos();

        // Cargar dispositivos
        await cargarDispositivosUsuario();
        await cargarDispositivosProceso();
    }

    /* =============================================================================
       📦 DISPOSITIVOS REGISTRADOS DEL USUARIO (Todos los que tiene)
    ============================================================================= */

    async function cargarDispositivosUsuario() {
        try {
            console.log(`📦 Cargando dispositivos registrados de ${tipoPersonaActual} ID: ${idPropietarioActual}`);

            const res = await fetch(API.owner(tipoPersonaActual, idPropietarioActual));

            if (!res.ok) {
                ownerContainer.innerHTML = `<p class="text-muted text-center">Sin dispositivos registrados.</p>`;
                return;
            }

            const dispositivos = await res.json();
            console.log(`✅ ${dispositivos.length} dispositivos encontrados`);

            if (dispositivos.length === 0) {
                ownerContainer.innerHTML = `<p class="text-muted text-center">Sin dispositivos registrados.</p>`;
                return;
            }

            ownerContainer.innerHTML = dispositivos.map(d => {
                const tipoElem = d.tipoElemento || d.TipoElemento || {};
                const tipoNombre = tipoElem.tipo || tipoElem.Tipo || "Dispositivo";

                return `
                    <div class="device-item">
                        <div class="device-icon">
                            <i class="bi bi-${getIconoDispositivo(tipoNombre)}"></i>
                        </div>
                        <div>
                            <strong class="device-name">${tipoNombre}</strong><br>
                            <span class="device-details">
                                ${d.marca ? `<strong>${d.marca}</strong> ` : ''}
                                ${d.modelo || ''}<br>
                                📟 Serial: ${d.serial || 'N/A'}
                            </span>
                        </div>
                    </div>
                `;
            }).join("");

        } catch (error) {
            console.error("❌ Error cargando dispositivos del usuario:", error);
            ownerContainer.innerHTML = `<p class="text-danger text-center">Error al cargar dispositivos</p>`;
        }
    }

    /* =============================================================================
       🔧 DISPOSITIVOS EN PROCESO ACTUAL (Solo los del ingreso/salida)
    ============================================================================= */

    async function cargarDispositivosProceso() {
        try {
            console.log(`📦 Cargando dispositivos del proceso ${procesoActualId}...`);

            const res = await fetch(API.byProceso(procesoActualId));

            if (!res.ok) {
                console.error(`❌ Error HTTP ${res.status}: ${res.statusText}`);
                processContainer.innerHTML = `<p class="text-danger text-center">Error al cargar dispositivos del proceso.</p>`;
                return;
            }

            const lista = await res.json();
            console.log(`📊 Dispositivos en proceso: ${lista.length}`);

            if (lista.length === 0) {
                const esIngreso = modoActual === "Ingreso";
                processContainer.innerHTML = `
                    <div class="alert alert-${esIngreso ? 'info' : 'warning'} text-center mb-0">
                        <i class="bi bi-${esIngreso ? 'info-circle' : 'exclamation-triangle'}"></i>
                        ${esIngreso
                            ? "No hay dispositivos registrados. Usa el botón de abajo para agregar."
                            : "⚠️ No se detectaron dispositivos del ingreso. Verifica que sea el proceso correcto."}
                    </div>
                `;
                return;
            }

            processContainer.innerHTML = lista.map(ep => {
                const d = ep.elemento || ep.Elemento || {};
                const relId = ep.idElementoProceso || ep.IdElementoProceso;
                const tipoElemento = d.tipoElemento || d.TipoElemento || {};
                const tipoNombre = tipoElemento.tipo || tipoElemento.Tipo || "Dispositivo";

                const esSalida = modoActual === "Salida";

                return `
                    <div class="device-item">
                        <div class="device-icon">
                            <i class="bi bi-${getIconoDispositivo(tipoNombre)}"></i>
                        </div>
                        <div style="flex:1">
                            <strong class="device-name">${tipoNombre}</strong><br>
                            <span class="device-details">
                                ${d.marca ? `<strong>${d.marca}</strong> ` : ''}
                                ${d.modelo || ''}<br>
                                📟 Serial: ${d.serial || 'N/A'}
                            </span>
                        </div>
                        ${esSalida ? `
                            <button class="btn btn-danger btn-sm" onclick="removeFromProcess(${relId})"
                                    title="No lo saqué (dejarlo en SENA)">
                                <i class="bi bi-x-circle"></i> No lo saqué
                            </button>
                        ` : `
                            <button class="btn btn-outline-danger btn-sm" onclick="removeFromProcess(${relId})"
                                    title="Quitar del proceso">
                                <i class="bi bi-trash"></i>
                            </button>
                        `}
                    </div>
                `;
            }).join("");

        } catch (error) {
            console.error("❌ Error cargando dispositivos del proceso:", error);
            processContainer.innerHTML = `<p class="text-danger text-center">Error de conexión</p>`;
        }
    }

    /* =============================================================================
       🎨 ICONO SEGÚN TIPO DE DISPOSITIVO
    ============================================================================= */

    function getIconoDispositivo(tipo) {
        const iconos = {
            'Portátil': 'laptop',
            'Computador': 'pc-display',
            'PC': 'pc-display',
            'Tablet': 'tablet',
            'Mouse': 'mouse',
            'Teclado': 'keyboard',
            'Cargador': 'plug',
            'Celular': 'phone',
            'Teléfono': 'phone',
            'Audífonos': 'headphones',
            'Audífono': 'headphones',
            'Monitor': 'display',
            'Impresora': 'printer',
            'USB': 'usb-drive',
            'Disco Duro': 'device-hdd',
            'Cámara': 'camera'
        };

        return iconos[tipo] || 'hdd';
    }

    /* =============================================================================
       ❌ QUITAR DISPOSITIVO DEL PROCESO
    ============================================================================= */

    async function removeFromProcess(relId) {
        const mensaje = modoActual === "Salida"
            ? "¿Confirmar que NO sacaste este dispositivo del SENA?"
            : "¿Quitar este dispositivo del proceso actual?";

        if (!confirm(mensaje)) return;

        try {
            const res = await fetch(API.desvincular(relId), { method: "DELETE" });

            if (res.ok) {
                showToast("✅ Dispositivo removido del proceso", "warning");
                await cargarDispositivosProceso();
            } else {
                showToast("❌ Error al quitar dispositivo", "danger");
            }
        } catch (error) {
            console.error("❌ Error eliminando dispositivo:", error);
            showToast("❌ Error de conexión", "danger");
        }
    }

    /* =============================================================================
       📝 MODAL - CARGAR DATOS
    ============================================================================= */

    document.getElementById("modalAddDevice").addEventListener("show.bs.modal", async () => {
        modalUserData.innerHTML = "Cargando...";
        modalUserDevices.innerHTML = `<p class="text-muted text-center">Cargando...</p>`;

        if (!idPropietarioActual) {
            modalUserData.innerHTML = `<span class="text-danger">⚠️ No hay usuario cargado</span>`;
            return;
        }

        modalUserData.innerHTML = `
            <strong>${nombreUsuarioActual}</strong><br>
            <span class="badge bg-primary">${tipoPersonaActual}</span>
        `;

        await cargarDispositivosModal();
    });

    /* =============================================================================
       📋 MODAL - DISPOSITIVOS EXISTENTES
    ============================================================================= */

    async function cargarDispositivosModal() {
        try {
            const res = await fetch(API.owner(tipoPersonaActual, idPropietarioActual));

            if (!res.ok) {
                modalUserDevices.innerHTML = `<p class="text-muted text-center">Sin dispositivos.</p>`;
                return;
            }

            const dispositivos = await res.json();

            modalUserDevices.innerHTML = dispositivos.length === 0
                ? `<p class="text-muted text-center">Sin dispositivos registrados.</p>`
                : dispositivos.map(d => {
                    const tipoElem = d.tipoElemento || d.TipoElemento || {};
                    const tipoNombre = tipoElem.tipo || tipoElem.Tipo || "Dispositivo";

                    return `
                        <div class="device-item">
                            <div class="device-icon">
                                <i class="bi bi-${getIconoDispositivo(tipoNombre)}"></i>
                            </div>
                            <div>
                                <strong>${tipoNombre}</strong><br>
                                ${d.marca || ''} ${d.modelo || ''}<br>
                                Serial: ${d.serial || 'N/A'}
                            </div>
                        </div>
                    `;
                }).join("");

        } catch (error) {
            console.error("❌ Error cargando dispositivos del modal:", error);
            modalUserDevices.innerHTML = `<p class="text-danger text-center">Error al cargar</p>`;
        }
    }

    /* =============================================================================
       ➕ CREAR NUEVO DISPOSITIVO
    ============================================================================= */

    document.getElementById("btnGuardarDevice").onclick = async () => {
        if (!selTipoElemento.value || !inpSerial.value.trim()) {
            showToast("⚠️ Complete los campos obligatorios (Tipo y Serial)", "danger");
            return;
        }

        const payload = {
            idTipoElemento: Number(selTipoElemento.value),
            idPropietario: idPropietarioActual,
            tipoPropietario: tipoPersonaActual,
            marca: inpMarca.value.trim(),
            modelo: inpModelo.value.trim(),
            serial: inpSerial.value.trim().toUpperCase(),
            descripcion: inpDescripcion.value.trim()
        };

        try {
            const res = await fetch(API.crearElem(), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                const nuevoElemento = await res.json();
                console.log("✅ Dispositivo creado:", nuevoElemento);

                showToast("✅ Dispositivo creado exitosamente", "success");

                // Vincular automáticamente al proceso si es INGRESO
                if (modoActual === "Ingreso") {
                    const idElemento = nuevoElemento.idElemento || nuevoElemento.IdElemento;

                    await fetch(API.vincular(), {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            idElemento: idElemento,
                            idProceso: procesoActualId,
                            validado: true
                        })
                    });

                    console.log("✅ Dispositivo vinculado al proceso automáticamente");
                }

                // Limpiar formulario
                inpSerial.value = "";
                inpMarca.value = "";
                inpModelo.value = "";
                inpDescripcion.value = "";

                // Recargar vistas
                await cargarDispositivosUsuario();
                await cargarDispositivosProceso();
                await cargarDispositivosModal();

                // Cerrar modal
                bootstrap.Modal.getInstance(document.getElementById("modalAddDevice")).hide();
            } else {
                const error = await res.json();
                showToast(error.message || "❌ Error al crear dispositivo", "danger");
            }
        } catch (error) {
            console.error("❌ Error creando dispositivo:", error);
            showToast("❌ Error de conexión", "danger");
        }
    };

    /* =============================================================================
       🎛️ CARGAR TIPOS DE DISPOSITIVOS
    ============================================================================= */

    async function cargarTipos() {
        try {
            const res = await fetch(API.tipos());
            const tipos = await res.json();

            selTipoElemento.innerHTML = tipos.map(t =>
                `<option value="${t.idTipoElemento || t.IdTipoElemento}">
                    ${t.tipo || t.Tipo}
                </option>`
            ).join("");

            console.log(`✅ ${tipos.length} tipos de dispositivos cargados`);
        } catch (error) {
            console.error("❌ Error cargando tipos:", error);
            selTipoElemento.innerHTML = `<option value="">Error al cargar tipos</option>`;
        }
    }

    cargarTipos();

    /* =============================================================================
       📡 SIGNALR - LECTURA NFC AUTOMÁTICA
    ============================================================================= */

    const connection = new signalR.HubConnectionBuilder()
        .withUrl(HUB_URL)
        .withAutomaticReconnect([0, 2000, 5000, 10000])
        .build();

    connection.on("OperacionProcesada", async raw => {
        console.log("📡 Evento recibido desde SignalR:", raw);

        limpiarProceso();

        const payload = typeof raw === "string" ? JSON.parse(raw) : raw;
        const proceso = payload.proceso || payload.Proceso;
        const registro = payload.registro || payload.Registro;

        if (!validarProceso(proceso)) {
            console.error("❌ Datos de proceso inválidos:", proceso);
            showToast("❌ Datos inválidos recibidos del servidor", "danger");
            return;
        }

        const tipo = proceso.tipoPersona || proceso.TipoPersona;
        const id = tipo === "Aprendiz"
            ? (proceso.idAprendiz || proceso.IdAprendiz)
            : (proceso.idUsuario || proceso.IdUsuario);

        try {
            const data = await (await fetch(
                tipo === "Aprendiz" ? API.aprendiz(id) : API.usuario(id)
            )).json();

            const persona = mapPersona(tipo, data);
            await showProfile(persona, tipo, proceso, registro);

            const tipoReg = registro.tipoRegistro || registro.TipoRegistro;
            const esIngreso = tipoReg === "Ingreso";

            lastDetected.innerHTML = `
                <div class="d-flex gap-2 align-items-center justify-content-center">
                    <div class="device-icon">
                        <i class="bi bi-person-check-fill text-${esIngreso ? "success" : "warning"}" style="font-size:2rem"></i>
                    </div>
                    <div>
                        <strong>${persona.nombreCompleto}</strong><br>
                        <small class="badge bg-${esIngreso ? "success" : "warning"}">
                            ${esIngreso ? "🟢" : "🟠"} ${tipoReg}
                        </small>
                    </div>
                </div>
            `;

            showToast(`✅ ${tipoReg} registrado: ${persona.nombreCompleto}`, "success");

        } catch (error) {
            console.error("❌ Error procesando datos de la persona:", error);
            showToast("❌ Error al procesar la operación", "danger");
        }
    });

    connection.onreconnecting(error => {
        console.warn("⚠️ Reconectando SignalR...", error);
        showToast("⚠️ Reconectando con el servidor...", "warning");
    });

    connection.onreconnected(connectionId => {
        console.log("✅ SignalR reconectado:", connectionId);
        showToast("✅ Conexión restablecida", "success");
    });

    connection.onclose(error => {
        console.error("❌ Conexión SignalR cerrada:", error);
        showToast("❌ Conexión perdida. Recargando página...", "danger");
        setTimeout(() => location.reload(), 3000);
    });

    connection.start().then(() => {
        console.log("✅ Conexión SignalR establecida correctamente");
        showToast("🟢 Sistema NFC habilitado", "success");
    }).catch(err => {
        console.error("❌ Error conectando SignalR:", err);
        showToast("❌ Error de conexión NFC. Verifique el servidor.", "danger");
    });

    /* =============================================================================
       📜 HISTORIAL
    ============================================================================= */

    function addHistory(tipo, fecha, nombre) {
        const item = document.createElement("div");
        const esIngreso = tipo === "Ingreso";

        item.className = `history-item ${esIngreso ? "ingreso" : "salida"}`;
        item.innerHTML = `
            <strong>${esIngreso ? "🟢" : "🟠"} ${tipo}</strong> — ${nombre}<br>
            <small>${new Date(fecha).toLocaleString("es-CO", {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            })}</small>
        `;

        historyList.prepend(item);

        // Limitar historial a 20 items
        while (historyList.children.length > 20) {
            historyList.lastChild.remove();
        }
    }

    /* =============================================================================
       🔄 BOTÓN NUEVO PROCESO
    ============================================================================= */

    document.getElementById("btnNuevoProceso").addEventListener("click", () => {
        if (procesoActualId) {
            if (!confirm("¿Desea iniciar un nuevo proceso? Se limpiará la información actual.")) {
                return;
            }
        }
        limpiarProceso();
        showToast("🔄 Esperando nueva lectura NFC...", "info");
        console.log("🔄 Proceso limpiado, esperando nuevo tag");
    });




</script>