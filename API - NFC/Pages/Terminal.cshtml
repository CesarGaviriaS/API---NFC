@page
@model API___NFC.Pages.TerminalModel
@{
    ViewData["Title"] = "NFC HUB (Terminal)";
    Layout = "_AdminLayout";
}

<style>
    :root {
        --sena-verde: #39A900;
        --sena-verde-osc: #2d8700;
        --sena-azul: #0B7CBD;
        --sena-amarillo: #FFC300;
        --sena-naranja: #FF6600;
        --borde-suave: #e1e8ed;
        --fondo: #f5f8fa;
        --texto: #1a1a1a;
        --sombra: 0 2px 8px rgba(0,0,0,0.08);
    }

    body {
        background: var(--fondo);
    }

    .card {
        border-radius: 16px;
        box-shadow: var(--sombra);
        border: none;
        overflow: hidden;
        transition: .3s;
    }

        .card:hover {
            transform: translateY(-2px);
        }

    .card-header {
        font-weight: 700;
        border: none;
        background: linear-gradient(135deg,var(--sena-verde),var(--sena-azul));
        color: white;
    }

    #history-list {
        max-height: 80vh;
        overflow-y: auto;
    }

    .history-item {
        background: #fff;
        border-left: 5px solid var(--sena-azul);
        margin-bottom: .5rem;
        border-radius: 8px;
        padding: .75rem;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

        .history-item.ingreso {
            border-left-color: var(--sena-verde);
        }

        .history-item.salida {
            border-left-color: var(--sena-naranja);
        }

    .profile-card {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .profile-avatar {
        width: 90px;
        height: 90px;
        border-radius: 20px;
        background: linear-gradient(135deg,var(--sena-verde),var(--sena-azul));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2.5rem;
        overflow: hidden;
    }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .profile-name {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: .3rem;
    }

    .profile-role {
        color: var(--sena-verde);
        font-weight: 600;
        text-transform: uppercase;
        font-size: .85rem;
    }

    .profile-program {
        background: #f9fafb;
        border-left: 4px solid var(--sena-verde);
        border-radius: 12px;
        padding: .75rem 1rem;
        margin-top: 1rem;
        font-size: .9rem;
    }

    #last-detected-item-content .element-item {
        border: 2px solid var(--sena-azul);
        border-radius: 12px;
        background: linear-gradient(135deg,#e3f2fd,#e8f5e9);
        padding: 1rem;
        margin: 0;
    }

    .toast {
        border: none;
        border-radius: 12px;
        box-shadow: var(--sombra);
    }
</style>

<div class="container-fluid py-4">
    <div class="row g-3">
        <!-- Panel izquierdo: historial -->
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-header text-center"><i class="bi bi-clock-history me-2"></i>Historial</div>
                <div class="card-body" id="history-list">
                    <p class="text-muted small text-center mt-3">Sin registros</p>
                </div>
            </div>
        </div>

        <!-- Panel derecho principal -->
        <div class="col-md-9 d-flex flex-column gap-3">
            <!-- Perfil -->
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0 text-success"><i class="bi bi-person-badge me-2"></i>Perfil</h5>
                    <button id="btnNuevoProceso" class="btn btn-success d-flex align-items-center gap-2">
                        <i class="bi bi-broadcast-pin"></i> Iniciar Proceso
                    </button>
                </div>
                <div id="user-profile-content" class="p-2 text-muted">Esperando lectura...</div>
            </div>

            <!-- Último elemento detectado -->
            <div class="card">
                <div class="card-header text-center" style="background:linear-gradient(135deg,var(--sena-azul),#1e88e5)">Último Elemento Detectado</div>
                <div class="card-body" id="last-detected-item-content">
                    <p class="text-center text-muted">Esperando escaneo...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div id="toast-container" style="position:fixed;bottom:1rem;right:1rem;z-index:1050;"></div>
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>

    <script>
        const HUB_URL = `${window.location.origin}/nfcHub`;
        const API = {
            aprendiz: id => `${window.location.origin}/api/Aprendiz/${id}`,
            usuario: id => `${window.location.origin}/api/Usuario/${id}`
        };

        const connection = new signalR.HubConnectionBuilder()
            .withUrl(HUB_URL)
            .withAutomaticReconnect()
            .build();

        const historyList = document.getElementById("history-list");
        const profileDiv = document.getElementById("user-profile-content");
        const lastDetected = document.getElementById("last-detected-item-content");
        const btn = document.getElementById("btnNuevoProceso");

        // === UI Helpers ===
        const showToast = (msg, type='info')=>{
            const el=document.createElement('div');
            el.className=`toast align-items-center text-bg-${type} show`;
            el.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
            document.getElementById("toast-container").appendChild(el);
            setTimeout(()=>el.remove(),4000);
        }

        const addHistory = (tipo,fecha,nombre)=>{
            const el=document.createElement('div');
            el.className=`history-item ${tipo.toLowerCase()}`;
            el.innerHTML=`<strong>${tipo}</strong> — ${nombre}<br><small>${new Date(fecha).toLocaleString()}</small>`;
            historyList.prepend(el);
        }

        const showProfile = (persona,tipoPersona,proceso,registro)=>{
            profileDiv.innerHTML=`
                <div class="profile-card">
                    <div class="profile-avatar">
                        ${persona.fotoUrl?`<img src="${persona.fotoUrl}" alt="Foto">`:`<i class="bi bi-person-circle"></i>`}
                    </div>
                    <div class="profile-info">
                        <p class="profile-role">${tipoPersona}</p>
                        <h4 class="profile-name">${persona.nombreCompleto}</h4>
                        <p class="text-muted">${registro.TipoRegistro} — ${new Date(registro.FechaRegistro).toLocaleString()}</p>
                        <div class="profile-program">
                            📄 ${persona.documento || '—'}<br>
                            ✉️ ${persona.correo || '—'}<br>
                            🎓 ${persona.extra || '—'}<br>
                            🧾 Código: ${persona.codigoBarras || '—'}<br>
                            ⚙️ Proceso: ${proceso.IdProceso}
                        </div>
                    </div>
                </div>`;
        }

        const updateLastDetected = (tipo, persona)=>{
            lastDetected.innerHTML=`
                <div class="element-item highlighted">
                    <img src="${persona.fotoUrl || '/img/default-user.png'}" class="element-image" alt="Foto">
                    <div class="element-details">
                        <strong>${persona.nombreCompleto}</strong>
                        <p>${tipo} — ${new Date().toLocaleTimeString()}</p>
                        <p>${persona.documento}</p>
                    </div>
                </div>`;
        }

        const mapPersona=(tipo,data)=>{
            if(tipo==='Aprendiz'){
                return {
                    id:data.idAprendiz,
                    nombreCompleto:`${data.nombre||''} ${data.apellido||''}`.trim(),
                    documento:`${data.tipoDocumento||''} ${data.numeroDocumento||''}`.trim(),
                    correo:data.correo||'',
                    extra:data.ficha?.codigo?`Ficha ${data.ficha.codigo}`:'',
                    codigoBarras:data.codigoBarras||'',
                    fotoUrl:data.fotoUrl||null
                };
            }else{
                return {
                    id:data.idUsuario,
                    nombreCompleto:`${data.nombre||''} ${data.apellido||''}`.trim(),
                    documento:`${data.tipoDocumento||''} ${data.numeroDocumento||''}`.trim(),
                    correo:data.correo||'',
                    extra:data.rol||'',
                    codigoBarras:data.codigoBarras||'',
                    fotoUrl:data.fotoUrl||null
                };
            }
        }

        // === EVENTOS DEL HUB ===
        connection.on("OperacionProcesada", async (json)=>{
            try{
                const payload=JSON.parse(json);
                const proceso=payload.Proceso;
                const registro=payload.Registro;
                const tipoPersona=proceso.TipoPersona;
                const id=(tipoPersona==="Aprendiz")?proceso.IdAprendiz:proceso.IdUsuario;

                const res=await fetch(tipoPersona==="Aprendiz"?API.aprendiz(id):API.usuario(id));
                if(!res.ok) throw new Error("No se pudo obtener los datos");
                const persona=mapPersona(tipoPersona, await res.json());

                showProfile(persona,tipoPersona,proceso,registro);
                updateLastDetected(registro.TipoRegistro,persona);
                addHistory(registro.TipoRegistro,registro.FechaRegistro,persona.nombreCompleto);
                showToast(`✅ ${registro.TipoRegistro} de ${persona.nombreCompleto}`,"success");
            }catch(e){
                console.error(e);
                showToast("Error procesando lectura","danger");
            }
        });

        connection.on("OperacionError",msg=>showToast("⚠️ "+msg,"danger"));
        connection.on("AgentStatusUpdate",(msg,type)=>showToast(msg,type==='warning'?'danger':'info'));

        btn.addEventListener("click",async()=>{
            await connection.invoke("SetAgentModeToRead");
            showToast("📶 Modo lectura activo. Pase un tag...","info");
        });

        async function startHub(){
            try{
                await connection.start();
                console.log("✅ Conectado al Hub");
                showToast("Conectado al Hub NFC","success");
            }catch(e){
                console.error(e);
                showToast("No se pudo conectar al Hub","danger");
                setTimeout(startHub,4000);
            }
        }
        startHub();
    </script>
}
