@page
@{
    ViewData["Title"] = "Gestión de Tags NFC";
    Layout = "_AdminLayout";
}

<div class="container-fluid mt-4">
    <div class="row">
        <!-- Columna Principal -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4><i class="fas fa-id-card-alt me-2"></i>Gestión de Tags NFC</h4>
                </div>

                <div class="card-body">

                    <!-- 1️⃣ Selección de tipo de persona -->
                    <div class="mb-4 border rounded p-3">
                        <h5><i class="fas fa-user-tag me-2"></i>Seleccionar Tipo</h5>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoPersona" id="radioAprendiz" value="Aprendiz">
                            <label class="form-check-label" for="radioAprendiz">Aprendiz</label>
                        </div>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoPersona" id="radioUsuario" value="Usuario">
                            <label class="form-check-label" for="radioUsuario">Usuario / Administrador</label>
                        </div>
                    </div>

                    <!-- 2️⃣ Asignación del Tag -->
                    <div class="mb-4 border rounded p-3">
                        <h5><i class="fas fa-id-badge me-2"></i>Asignar Tag</h5>

                        <div class="row g-3">

                            <!-- 🔍 Búsqueda dinámica -->
                            <div class="col-md-6">
                                <label class="form-label">Seleccione Persona</label>

                                <div class="position-relative">
                                    <input id="searchPersona" class="form-control" disabled placeholder="Ingrese documento o nombre...">

                                    <div id="resultPersona"
                                         class="list-group position-absolute w-100 shadow-sm"
                                         style="z-index:1000; max-height:200px; overflow-y:auto; display:none;">
                                    </div>
                                </div>

                                <!-- Hidden para mantener compatibilidad -->
                                <input type="hidden" id="selectPersona">
                            </div>

                            <!-- Tipo de Dispositivo -->
                            <div class="col-md-6">
                                <label for="selectTipoElemento" class="form-label">Tipo de Dispositivo</label>
                                <select id="selectTipoElemento" class="form-select" disabled>
                                    <option selected disabled>Seleccione tipo de dispositivo</option>
                                </select>
                            </div>
                        </div>

                        <!-- Datos del dispositivo -->
                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label for="txtMarca" class="form-label">Marca</label>
                                <input type="text" id="txtMarca" class="form-control" placeholder="Ej: HP, Dell..." disabled>
                            </div>

                            <div class="col-md-6">
                                <label for="txtModelo" class="form-label">Modelo</label>
                                <input type="text" id="txtModelo" class="form-control" placeholder="Ej: ProBook 450" disabled>
                            </div>

                            <div class="col-md-6">
                                <label for="txtSerial" class="form-label">Serial</label>
                                <input type="text" id="txtSerial" class="form-control" placeholder="Número de serie" disabled>
                            </div>

                            <div class="col-md-6">
                                <label for="txtDescripcion" class="form-label">Descripción</label>
                                <input type="text" id="txtDescripcion" class="form-control" placeholder="Detalles adicionales" disabled>
                            </div>

                            <!-- Foto del dispositivo -->
                            <div class="col-md-6">
                                <label for="fileFoto" class="form-label">Foto del Dispositivo</label>
                                <input type="file" id="fileFoto" class="form-control" accept="image/*" capture="environment" disabled>
                                <small class="text-muted">Toma una foto o selecciona una imagen del dispositivo.</small>

                                <div class="mt-2 text-center">
                                    <img id="previewFoto" class="img-thumbnail" style="max-height:150px; display:none;" />
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-light mt-3" role="alert">
                            <strong>Datos a grabar:</strong>
                            <span id="data-to-write-display" class="font-monospace text-primary">N/A</span>
                        </div>

                        <div class="d-grid">
                            <button id="btnGrabar" class="btn btn-success btn-lg" disabled>
                                <i class="fas fa-save me-2"></i>Preparar para Grabar
                            </button>
                        </div>
                    </div>

                    <!-- 3️⃣ Limpieza -->
                    <div class="p-3 border rounded">
                        <h5><i class="fas fa-eraser me-2"></i>Otras acciones</h5>

                        <div class="d-grid">
                            <button id="btnLimpiar" class="btn btn-danger">
                                <i class="fas fa-trash-alt me-2"></i>Preparar para Limpiar Tag
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Panel Estado -->
        <div class="col-lg-4">
            <div class="card position-sticky shadow" style="top:1rem;">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-satellite-dish me-2"></i>Estado del Agente</h5>
                </div>

                <div class="card-body">

                    <div id="status-panel" class="alert alert-secondary text-center">
                        <div id="status-message">Conectando con el agente...</div>
                    </div>

                    <h6 class="mt-4">Último Tag leído</h6>
                    <div id="last-read-panel" class="p-2 bg-light rounded">
                        <p class="text-muted text-center small mb-0">No se ha leído ningún tag.</p>
                    </div>

                    <div class="d-grid mt-3">
                        <button id="btnLeer" class="btn btn-info">
                            <i class="fas fa-sync-alt me-2"></i>Modo Lectura
                        </button>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
}
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {

            const apiBase = `${window.location.origin}/api`;

            const tipoRadios = document.getElementsByName("tipoPersona");
            const selectPersona = document.getElementById("selectPersona");
            const searchPersona = document.getElementById("searchPersona");
            const resultPersona = document.getElementById("resultPersona");

            const selectTipoElemento = document.getElementById("selectTipoElemento");
            const txtMarca = document.getElementById("txtMarca");
            const txtModelo = document.getElementById("txtModelo");
            const txtSerial = document.getElementById("txtSerial");
            const txtDescripcion = document.getElementById("txtDescripcion");

            const fileFoto = document.getElementById("fileFoto");
            const previewFoto = document.getElementById("previewFoto");

            const dataDisplay = document.getElementById("data-to-write-display");
            const btnGrabar = document.getElementById("btnGrabar");
            const btnLimpiar = document.getElementById("btnLimpiar");
            const btnLeer = document.getElementById("btnLeer");

            const statusPanel = document.getElementById("status-panel");
            const statusMessage = document.getElementById("status-message");
            const lastReadPanel = document.getElementById("last-read-panel");

            let fotoUrl = null;


            /* ============================================================
               🔵 ESTADO DEL AGENTE
            ============================================================ */

            const updateStatus = (msg, type='info')=>{
                const map={
                    info:'alert-info',
                    success:'alert-success',
                    error:'alert-danger',
                    warning:'alert-warning'
                };
                statusPanel.className=`alert ${map[type]||'alert-info'} text-center`;
                statusMessage.textContent=msg;
            };


            /* ============================================================
               🖼️ SUBIR FOTO Y MOSTRAR VISTA PREVIA
            ============================================================ */

            const uploadPhoto = async (file) => {
                const formData = new FormData();
                formData.append("file", file);

                const res = await fetch(`${apiBase}/Elementoes/upload-image`, {
                    method: "POST",
                    body: formData
                });

                if (!res.ok) throw new Error("Error al subir imagen");

                const data = await res.json();
                return data.imageUrl;
            };

            fileFoto.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        previewFoto.src = ev.target.result;
                        previewFoto.style.display = 'block';
                    };
                    reader.readAsDataURL(file);

                    try {
                        fotoUrl = await uploadPhoto(file);
                        // ✅ Imagen subida sin alerta
                    } catch (err) {
                        updateStatus("❌ Error al subir imagen: " + err.message, "error");
                    }
                }
            });


            /* ============================================================
               🔗 CONEXIÓN SIGNALR
            ============================================================ */

            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/nfcHub")
                .withAutomaticReconnect()
                .build();


            /* ============================================================
               🟢 CARGA DE TIPOS DE ELEMENTO
            ============================================================ */

            const loadTiposElemento = async () => {

                selectTipoElemento.disabled = true;
                selectTipoElemento.innerHTML = '<option selected disabled>Cargando tipos...</option>';

                try {
                    const res = await fetch(`${apiBase}/TipoElementoes`);
                    const tipos = await res.json();

                    selectTipoElemento.innerHTML = '<option selected disabled>-- Seleccione tipo de dispositivo --</option>';

                    tipos.forEach(t =>
                        selectTipoElemento.add(new Option(t.tipo, t.idTipoElemento))
                    );

                    [txtMarca, txtModelo, txtSerial, txtDescripcion, fileFoto]
                        .forEach(el => el.disabled = false);

                    selectTipoElemento.disabled = false;

                } catch {
                    updateStatus("❌ Error al cargar tipos de elemento", "error");
                }
            };


            /* ============================================================
               🟣 LÓGICA PARA ARMAR EL DATO A GRABAR
            ============================================================ */

            const updateDataToWrite = () => {
                const tipo = document.querySelector('input[name="tipoPersona"]:checked')?.value;
                const personaId = selectPersona.value;

                if (tipo && personaId) {
                    const tipoNum = tipo === "Aprendiz" ? 1 : 2;
                    const dataString = `${tipoNum},${personaId}`;
                    dataDisplay.textContent = dataString;
                    btnGrabar.disabled = false;
                } else {
                    dataDisplay.textContent = "N/A";
                    btnGrabar.disabled = true;
                }
            };


            /* ============================================================
               🟡 REGISTRO DEL ELEMENTO Y TAG
            ============================================================ */

            const registrarElementoYTag = async (codigoTag, tipoPersona, idPersona, idTipoElemento) => {
                try {
                    const elementoData = {
                        idTipoElemento: parseInt(idTipoElemento),
                        idPropietario: parseInt(idPersona),
                        tipoPropietario: tipoPersona,
                        marca: txtMarca.value.trim(),
                        modelo: txtModelo.value.trim(),
                        serial: txtSerial.value.trim(),
                        descripcion: txtDescripcion.value.trim(),
                        imagenUrl: fotoUrl,
                        estado: true,
                        codigoNFC: codigoTag
                    };

                    const resElem = await fetch(`${apiBase}/Elementoes`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(elementoData)
                    });

                    if (!resElem.ok) {
                        const msg = await resElem.text();
                        updateStatus("⚠️ Error al registrar elemento: " + msg, "warning");
                        return;
                    }

                    const dataElem = await resElem.json();

                    const tagData = {
                        codigoTag,
                        tipoPersona,
                        idPersona: parseInt(idPersona),
                        idElemento: dataElem.idElemento
                    };

                    const resTag = await fetch(`${apiBase}/TagAsignado`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(tagData)
                    });

                    if (resTag.ok) {
                        updateStatus("✅ Tag registrado correctamente", "success");
                    } else {
                        // Leer primero como texto para evitar error de stream
                        const responseText = await resTag.text();
                        let errorMessage = responseText;
                        
                        // Intentar parsear como JSON
                        try {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.message || responseText;
                        } catch {
                            // Ya está como texto, usar directamente
                        }
                        
                        // Verificar si es tag duplicado
                        if (resTag.status === 409 || errorMessage.includes('ya está asignado')) {
                            updateStatus("⚠️ Tag ya está asignado", "warning");
                        } else {
                            updateStatus("⚠️ Error al asignar tag", "warning");
                        }
                    }


                } catch (err) {
                    updateStatus("❌ Error: " + err.message, "error");
                }
            };


            /* ============================================================
               🟢 NUEVA FUNCIÓN → BÚSQUEDA INTELIGENTE
               (Documento, Nombre y Apellido)
               Opción 1: Solo usuarios Administrador / Funcionario
            ============================================================ */

            async function buscarPersonas(tipo, texto) {

                if (texto.length < 2) {
                    resultPersona.style.display = "none";
                    return;
                }

                let url = "";

                if (tipo === "Aprendiz") {
                    url = `${apiBase}/Aprendiz/search?query=${texto}`;
                }
                else {
                    url = `${apiBase}/Usuario/search?query=${texto}`;
                }

                try {
                    const res = await fetch(url);

                    if (!res.ok) {
                        resultPersona.innerHTML =
                            `<div class="list-group-item">No encontrado</div>`;
                        resultPersona.style.display = "block";
                        return;
                    }

                    let data = await res.json();

                    // Mantener comportamiento original → SOLO Administrador / Funcionario
                    if (tipo !== "Aprendiz") {
                        data = data.filter(x =>
                            x.rol === "Administrador" ||
                            x.rol === "Funcionario"
                        );
                    }

                    if (data.length === 0) {
                        resultPersona.innerHTML =
                            `<div class="list-group-item">Sin resultados</div>`;
                        resultPersona.style.display = "block";
                        return;
                    }

                    resultPersona.innerHTML = "";

                    data.forEach(p => {
                        const item = document.createElement("button");
                        item.className = "list-group-item list-group-item-action persona-item";
                        item.dataset.id = p.id;
                        item.textContent = `${p.nombre} — ${p.documento}`;

                        item.addEventListener("click", () => {
                            searchPersona.value = p.nombre + " (" + p.documento + ")";
                            selectPersona.value = p.id;

                            resultPersona.style.display = "none";
                            updateDataToWrite();
                        });

                        resultPersona.appendChild(item);
                    });

                    resultPersona.style.display = "block";

                } catch (err) {
                    console.error(err);
                }
            }


            /* ============================================================
               🟢 EVENTO: DIGITAR EN BUSCADOR
            ============================================================ */

            searchPersona.addEventListener("input", () => {
                const tipo = document.querySelector('input[name="tipoPersona"]:checked')?.value;
                if (!tipo) return;

                buscarPersonas(tipo, searchPersona.value.trim());
            });


            /* ============================================================
               🟢 EVENTO: CAMBIO DE TIPO DE PERSONA
            ============================================================ */

            tipoRadios.forEach(r => r.addEventListener("change", async e => {

                searchPersona.disabled = false;
                searchPersona.value = "";
                selectPersona.value = "";
                resultPersona.style.display = "none";

                await loadTiposElemento();

                updateDataToWrite();
            }));


            /* ============================================================
               🔵 NFC → GRABAR TAG
            ============================================================ */

            btnGrabar.addEventListener('click', async () => {

                const tipo = document.querySelector('input[name="tipoPersona"]:checked')?.value;
                const idPersona = selectPersona.value;
                const idTipoElemento = selectTipoElemento.value;

                if (dataDisplay.textContent === "N/A") return;

                await connection.invoke("SetAgentModeToWrite", dataDisplay.textContent);

                updateStatus("⏳ Preparando agente para grabar tag...", "info");

                window.__tagContext = { tipo, idPersona, idTipoElemento };
            });


            /* ============================================================
               🔵 NFC → LIMPIAR TAG
            ============================================================ */

            btnLimpiar.addEventListener('click', async () => {
                // Confirmación antes de limpiar
                if (!confirm('⚠️ ¿Está seguro que desea limpiar este tag?\n\nEsta acción:\n- Borrará el tag físicamente\n- Eliminará el elemento de la base de datos\n- NO se puede deshacer')) {
                    return;
                }
                
                await connection.invoke("SetAgentModeToClean");
                updateStatus("🧹 Agente listo para limpiar tag. Acerque el tag al lector...", "warning");
            });


            /* ============================================================
               🔵 NFC → MODO LECTURA
            ============================================================ */

            btnLeer.addEventListener('click', async () => {
                await connection.invoke("SetAgentModeToRead");
                updateStatus("📖 Modo lectura activado", "info");
            });


            /* ============================================================
               🔵 CONEXIÓN SIGNALR → RESPUESTAS
            ============================================================ */

            connection.on("AgentStatusUpdate", (msg, type) => updateStatus(msg, type));

            connection.on("OperationFailed", (msg) => updateStatus(msg, "error"));

            connection.on("RecibirDatosTag", (tagData) => {
                lastReadPanel.innerHTML = `<p class='text-primary font-monospace'>${tagData}</p>`;
            });

            connection.on("OperationSuccess", async (msg, verifiedData) => {
                updateStatus(msg, "success");

                lastReadPanel.innerHTML = `<p class='text-success font-monospace'>${verifiedData}</p>`;

                const ctx = window.__tagContext;
                if (ctx) {
                    await registrarElementoYTag(
                        verifiedData, ctx.tipo, ctx.idPersona, ctx.idTipoElemento
                    );
                    window.__tagContext = null;
                }
            });

            connection.on("TagCleanedSuccess", async (cleanedTagCode) => {
                console.log("Tag limpiado fisicamente: " + cleanedTagCode);
                try {
                    const res = await fetch(`${apiBase}/TagAsignado/cleanup/${cleanedTagCode}`, {
                        method: 'DELETE'
                    });
                    if (res.ok) {
                        const data = await res.json();
                        updateStatus(data.message, "success");
                        console.log("Tag eliminado de BD");
                        lastReadPanel.innerHTML = '<p class="text-muted text-center small mb-0">Tag limpiado correctamente</p>';
                    } else {
                        const error = await res.json();
                        updateStatus("Tag limpiado fisicamente pero: " + error.message, "warning");
                    }
                } catch (err) {
                    updateStatus("Tag limpiado fisicamente pero error al eliminar de BD", "warning");
                    console.error("Error:", err);
                }
            });


            /* ============================================================
               🔵 INICIAR CONEXIÓN
            ============================================================ */

            try {
                await connection.start();
                updateStatus("✅ Conectado al agente NFC.", "success");
            }
            catch {
                updateStatus("❌ Error al conectar con el agente.", "error");
            }

        });
    </script>
}
